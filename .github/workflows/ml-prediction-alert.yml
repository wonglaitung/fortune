name: ML Trading Model Prediction Alert

on:
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      horizon:
        description: 'È¢ÑÊµãÂë®Êúü (1=Ê¨°Êó•, 5=‰∏ÄÂë®, 20=‰∏Ä‰∏™Êúà, all=ÂÖ®ÈÉ®)'
        required: false
        default: 'all'
        type: choice
        options:
          - '1'
          - '5'
          - '20'
          - 'all'
  # ÂÆöÊó∂Ëß¶Âèë
  schedule:
    # ÊØèÂ§©È¶ôÊ∏ØÊó∂Èó¥ 09:00 (UTC 01:00) ÊâßË°åÈ¢ÑÊµã
    - cron: '0 1 * * 1-5'
    # ÊØèÂ§©È¶ôÊ∏ØÊó∂Èó¥ 16:30 (UTC 08:30) ÊâßË°åÈ¢ÑÊµã
    - cron: '30 8 * * 1-5'

jobs:
  predict-and-alert:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check if models exist
        id: check-models
        run: |
          if [ -f "data/ml_trading_model_lgbm_1d.pkl" ] && [ -f "data/ml_trading_model_lgbm_5d.pkl" ] && [ -f "data/ml_trading_model_lgbm_20d.pkl" ]; then
            echo "models_exist=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Ê®°ÂûãÊñá‰ª∂Â∑≤Â≠òÂú®"
          else
            echo "models_exist=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Ê®°ÂûãÊñá‰ª∂‰∏çÂ≠òÂú®ÔºåÈúÄË¶ÅËÆ≠ÁªÉ"
          fi

      - name: Train models if needed
        if: steps.check-models.outputs.models_exist == 'false'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          echo "üå≥ ÂºÄÂßãËÆ≠ÁªÉÊ®°Âûã..."
          python ml_trading_model.py --mode train --horizon 1 --model-type both --model-path data/ml_trading_model.pkl
          python ml_trading_model.py --mode train --horizon 5 --model-type both --model-path data/ml_trading_model.pkl
          python ml_trading_model.py --mode train --horizon 20 --model-type both --model-path data/ml_trading_model.pkl
          echo "‚úÖ Ê®°ÂûãËÆ≠ÁªÉÂÆåÊàê"

      - name: Run prediction for 1 day horizon
        if: github.event.inputs.horizon == '1' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          python ml_trading_model.py --mode predict --horizon 1 --model-type both --model-path data/ml_trading_model.pkl

      - name: Run prediction for 5 days horizon
        if: github.event.inputs.horizon == '5' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          python ml_trading_model.py --mode predict --horizon 5 --model-type both --model-path data/ml_trading_model.pkl

      - name: Run prediction for 20 days horizon
        if: github.event.inputs.horizon == '20' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          python ml_trading_model.py --mode predict --horizon 20 --model-type both --model-path data/ml_trading_model.pkl

      - name: Send prediction email
        if: github.event.inputs.horizon != '0' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          PREDICTION_HORIZONS: ${{ github.event.inputs.horizon == 'all' && '1,5,20' || github.event.inputs.horizon }}
        run: |
          python ml_prediction_email.py

      - name: Upload prediction results
        uses: actions/upload-artifact@v4
        with:
          name: ml-predictions-${{ github.run_number }}
          path: |
            data/ml_trading_model_lgbm_predictions_1d.csv
            data/ml_trading_model_lgbm_predictions_5d.csv
            data/ml_trading_model_lgbm_predictions_20d.csv
            data/ml_trading_model_gbdt_lr_predictions_1d.csv
            data/ml_trading_model_gbdt_lr_predictions_5d.csv
            data/ml_trading_model_gbdt_lr_predictions_20d.csv
          retention-days: 30