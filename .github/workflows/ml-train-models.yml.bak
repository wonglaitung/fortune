name: ML Trading Model Training

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      horizon:
        description: 'è®­ç»ƒå‘¨æœŸ (1=æ¬¡æ—¥, 5=ä¸€å‘¨, 20=ä¸€ä¸ªæœˆ, all=å…¨éƒ¨)'
        required: false
        default: 'all'
        type: choice
        options:
          - '1'
          - '5'
          - '20'
          - 'all'
  # å®šæ—¶è§¦å‘ - æ¯å‘¨æ—¥å‡Œæ™¨è®­ç»ƒæ¨¡å‹
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨ 08:00 (UTC 00:00)

jobs:
  train-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model for 1 day horizon
        if: github.event.inputs.horizon == '1' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          echo "ğŸŒ³ è®­ç»ƒæ¬¡æ—¥æ¶¨è·Œæ¨¡å‹ (horizon=1)..."
          python ml_trading_model.py --mode train --horizon 1 --model-type both --model-path data/ml_trading_model.pkl

      - name: Train model for 5 days horizon
        if: github.event.inputs.horizon == '5' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          echo "ğŸŒ³ è®­ç»ƒä¸€å‘¨æ¶¨è·Œæ¨¡å‹ (horizon=5)..."
          python ml_trading_model.py --mode train --horizon 5 --model-type both --model-path data/ml_trading_model.pkl

      - name: Train model for 20 days horizon
        if: github.event.inputs.horizon == '20' || github.event.inputs.horizon == 'all' || github.event_name == 'schedule'
        env:
          YAHOO_EMAIL: ${{ secrets.YAHOO_EMAIL }}
          YAHOO_APP_PASSWORD: ${{ secrets.YAHOO_APP_PASSWORD }}
          YAHOO_SMTP: ${{ secrets.YAHOO_SMTP }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          echo "ğŸŒ³ è®­ç»ƒä¸€ä¸ªæœˆæ¶¨è·Œæ¨¡å‹ (horizon=20)..."
          python ml_trading_model.py --mode train --horizon 20 --model-type both --model-path data/ml_trading_model.pkl

      - name: Upload trained models
        uses: actions/upload-artifact@v4
        with:
          name: ml-models-${{ github.run_number }}
          path: |
            data/ml_trading_model_lgbm_1d.pkl
            data/ml_trading_model_lgbm_5d.pkl
            data/ml_trading_model_lgbm_20d.pkl
            data/ml_trading_model_gbdt_lr_1d.pkl
            data/ml_trading_model_gbdt_lr_5d.pkl
            data/ml_trading_model_gbdt_lr_20d.pkl
            data/ml_trading_model_lgbm_1d_importance.csv
            data/ml_trading_model_lgbm_5d_importance.csv
            data/ml_trading_model_lgbm_20d_importance.csv
            data/ml_trading_model_gbdt_lr_1d_importance.csv
            data/ml_trading_model_gbdt_lr_5d_importance.csv
            data/ml_trading_model_gbdt_lr_20d_importance.csv
          retention-days: 90

      - name: Commit and push models to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/ml_trading_model_*.pkl data/ml_trading_model_*_importance.csv
          git diff --staged --quiet || git commit -m "æ›´æ–°MLæ¨¡å‹æ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M:%S')"
          git push