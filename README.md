# 金融信息监控与模拟交易系统

## 项目简介

本项目是一个综合性的金融信息监控与模拟交易系统，旨在为投资者提供全面的市场分析和交易策略验证工具。系统集成了多种金融数据源，利用技术分析、资金流向分析和大模型智能判断，帮助用户更好地理解市场动态并验证投资策略。

系统包含八个核心组件：
1. **加密货币价格监控器** - 实时获取主流加密货币的价格信息并通过邮件发送
2. **港股IPO信息获取器** - 爬取AAStocks网站获取最新的港股IPO信息
3. **港股主力资金追踪器** - 分析港股市场主力资金动向，识别建仓和出货信号
4. **港股主力资金历史数据分析器** - 分析历史数据中的信号模式
5. **港股模拟交易系统** - 基于主力资金追踪器的分析结果和大模型判断进行模拟交易
6. **批量获取自选股新闻** - 获取自选股相关的最新财经新闻并使用大模型分析相关性
7. **黄金市场分析器** - 分析黄金市场价格趋势和技术指标
8. **腾讯财经数据接口** - 提供更稳定和准确的港股及恒生指数数据

## 系统架构

```
金融信息监控与模拟交易系统
├── 数据获取层
│   ├── 加密货币价格监控器 (@crypto_email.py)
│   ├── 港股IPO信息获取器 (@hk_ipo_aastocks.py)
│   └── 黄金市场分析器 (@gold_analyzer.py)
├── 分析层
│   ├── 港股主力资金追踪器 (@hk_smart_money_tracker.py)
│   ├── 港股主力资金历史数据分析 (@hk_smart_money_historical_analysis.py)
│   └── 批量获取自选股新闻 (@batch_stock_news_fetcher.py)
├── 交易层
│   └── 港股模拟交易系统 (@simulation_trader.py)
└── 服务层
    ├── 大模型服务 (@llm_services/qwen_engine.py)
    └── 腾讯财经数据接口 (@tencent_finance.py)
```

## 核心功能

### 1. 数据获取与监控
- **实时数据获取**：获取加密货币和港股市场的实时价格数据
- **网络爬虫**：从AAStocks等网站获取IPO信息
- **新闻获取**：获取自选股相关的最新财经新闻
- **自动邮件通知**：将重要信息通过邮件发送给用户

### 2. 智能分析
- **技术指标分析**：MACD、RSI、OBV、均线等技术指标计算
- **资金流向分析**：沪港通/深港通南向资金数据获取与分析
- **信号识别**：自动识别主力资金建仓和出货信号
- **历史数据分析**：分析历史数据中的信号模式
- **新闻分析**：利用大模型分析新闻与股票的相关性
- **黄金市场分析**：获取黄金相关资产和宏观经济数据，进行技术分析

### 3. 模拟交易
- **大模型集成**：真实调用大模型进行股票分析和交易决策
- **结构化输出**：要求大模型以固定JSON格式输出买卖信号
- **风险偏好支持**：支持保守型、平衡型、进取型投资者设置
- **严格遵循**：严格按照大模型建议执行交易，无随机操作
- **状态持久化**：交易记录和状态自动保存，支持中断后继续
- **交易通知**：在无法按大模型建议执行交易时发送邮件通知
- **自动盈亏管理**：根据投资者类型和盈亏比例自动执行买卖操作
- **智能持仓管理**：动态跟踪持仓盈亏情况，根据大模型建议的止损价格自动止损
- **详细持仓展示**：提供详细的持仓信息，包括股票代码、名称、持有数量、平均成本、当前价格、持有金额、盈亏金额等
- **每日总结报告**：每日收盘后生成交易总结报告
- **手工交易支持**：支持手动执行卖出操作
- **邮件通知系统**：完善的邮件通知系统，包括买入、卖出、自动交易等各类通知

## 安装与配置

### 安装依赖

```bash
# 基础依赖
pip install requests beautifulsoup4 pandas

# 港股分析组件依赖
pip install yfinance akshare matplotlib numpy scipy

# 模拟交易系统依赖
pip install schedule

# 黄金分析器依赖
pip install yfinance pandas numpy

# 新闻获取器依赖
pip install akshare yfinance
```

### 环境变量配置

设置以下环境变量以启用邮件发送功能和大模型服务：

- `YAHOO_EMAIL`：发件人邮箱地址
- `YAHOO_APP_PASSWORD`：发件人邮箱应用密码
- `RECIPIENT_EMAIL`：收件人邮箱地址（可选，多个收件人用逗号分隔）
- `QWEN_API_KEY`：大模型API密钥（用于模拟交易系统和资金追踪器）
- `YAHOO_SMTP`：SMTP服务器地址（可选，默认为smtp.gmail.com）

## 组件详细说明

### 加密货币价格监控器 (@crypto_email.py)
- 实时获取比特币和以太坊的价格信息（USD和HKD）
- 支持获取24小时价格变化、市值和交易量
- 自动发送价格更新邮件
- 支持多个收件人

### 港股IPO信息获取器 (@hk_ipo_aastocks.py)
- 爬取AAStocks网站获取最新的港股IPO信息
- 提取公司名称、上市日期、行业、招股日期、每手股数、招股价格、入场费、暗盘日期等信息
- 保存IPO数据到CSV文件
- 发送IPO信息邮件

### 港股主力资金追踪器 (@hk_smart_money_tracker.py)
- 实时获取港股股票价格和交易数据（使用腾讯财经接口获取更准确的数据）
- 分析股票的技术指标（MACD、RSI、均线偏离、OBV等）
- 获取沪港通/深港通南向资金数据
- 识别主力资金建仓和出货信号
- 生成可视化图表
- 发送详细分析报告邮件
- 结合个股相关新闻进行综合分析
- 支持本地定时执行脚本 `send_alert.sh`

### 港股主力资金历史数据分析 (@hk_smart_money_historical_analysis.py)
- 分析指定时间段内的历史数据
- 识别历史上的建仓和出货信号日期
- 生成历史信号报告Excel文件
- 支持自定义分析时间范围

### 港股模拟交易系统 (@simulation_trader.py)
- 基于hk_smart_money_tracker的分析结果和大模型判断进行模拟交易
- 每60分钟执行一次交易分析
- 真实调用大模型进行股票分析，并要求以固定JSON格式输出买卖信号
- 支持保守型、平衡型、进取型投资者风险偏好设置
- 严格按照"先卖后买"的原则执行交易
- 买入时优先考虑没有持仓的股票
- 根据不同投资者类型（保守型、平衡型、进取型）自动进行盈亏比例交易
- 根据市场情况自动建议买入股票
- 在无法按大模型建议执行交易时（如资金不足或无持仓），会发送邮件通知，并包含大模型建议的买卖原因
- 交易记录和状态自动保存，支持中断后继续
- 完整的交易日志记录（按日期分割）
- 详细的持仓详情展示和每日总结功能
- 将大模型建议的买卖原因添加到所有通知邮件中，使用户能够更好地理解交易决策的依据
- 完全采用大模型建议的资金分配比例进行投资，系统不再自动计算投资比例，避免过度集中投资
- 大模型提示词已优化，去除买入股数字段，只保留资金分配比例字段，提高风险控制精度
- 删除了未使用的函数，如calculate_investment_percentage和get_current_positions_list，使代码更简洁

### 黄金市场分析器 (@gold_analyzer.py)
- 实时获取COMEX黄金期货和黄金ETF价格数据
- 计算技术指标（MACD、RSI、均线、布林带等）
- 分析黄金价格趋势和支撑阻力位
- 识别买卖信号
- 生成详细的分析报告
- 集成大模型深度分析黄金市场
- 支持本地定时执行脚本 `send_alert.sh`

### 批量获取自选股新闻 (@batch_stock_news_fetcher.py)
- 获取自选股相关的最新财经新闻
- 使用AKShare获取个股新闻数据
- 利用大模型分析新闻与股票的相关性
- 按时间由近到远排列新闻
- 将新闻数据持久化保存到CSV文件
- 支持定时运行模式

### 腾讯财经数据接口 (@tencent_finance.py)
- 通过腾讯财经API获取港股股票数据
- 通过腾讯财经API获取恒生指数数据
- 提供更稳定和准确的港股数据源

## 使用方法

### 基础组件使用

```bash
# 加密货币价格监控器
python crypto_email.py

# 港股IPO信息获取器
python hk_ipo_aastocks.py

# 港股主力资金追踪器
python hk_smart_money_tracker.py

# 港股主力资金历史数据分析
python hk_smart_money_historical_analysis.py --start-date 2025-01-01 --end-date 2025-09-30

# 黄金市场分析器
python gold_analyzer.py

# 个股新闻获取器
python batch_stock_news_fetcher.py

# 个股新闻获取器（定时运行模式）
python batch_stock_news_fetcher.py --schedule
```

### 模拟交易系统使用

```bash
# 运行模拟交易系统（默认90天）
python simulation_trader.py

# 运行指定天数的模拟交易
python simulation_trader.py --duration-days 30

# 设置分析频率（默认每60分钟）
python simulation_trader.py --analysis-frequency 60

# 手工卖出指定股票（例如：卖出0700.HK腾讯控股）
python simulation_trader.py --manual-sell 0700.HK

# 手工卖出指定股票的部分仓位（例如：卖出50%）
python simulation_trader.py --manual-sell 0700.HK --sell-percentage 0.5
```

### 本地定时执行

项目包含 `send_alert.sh` 脚本，可用于本地定时执行主力资金追踪和黄金分析：

```bash
# 编辑 crontab
crontab -e

# 添加以下行以每天执行（请根据需要调整时间）
0 6 * * * /data/fortune/send_alert.sh
```

## 配置参数

### 港股主力资金追踪器参数
在`hk_smart_money_tracker.py`代码顶部可以调整以下参数：

- `WATCHLIST`：自选股票列表
- `DAYS_ANALYSIS`：分析窗口天数
- `VOL_WINDOW`：成交量分析窗口
- `PRICE_WINDOW`：价格分析窗口
- `BUILDUP_MIN_DAYS`：建仓信号最小确认天数
- `DISTRIBUTION_MIN_DAYS`：出货信号最小确认天数
- 阈值参数：
  - `PRICE_LOW_PCT`：建仓信号价格百分位阈值
  - `PRICE_HIGH_PCT`：出货信号价格百分位阈值
  - `VOL_RATIO_BUILDUP`：建仓信号量比阈值
  - `VOL_RATIO_DISTRIBUTION`：出货信号量比阈值
  - `SOUTHBOUND_THRESHOLD`：南向资金阈值

### 模拟交易系统参数
在`simulation_trader.py`文件中可以调整以下参数：

- `investor_type`：投资者风险偏好（"保守型"、"平衡型"、"进取型"）
- `initial_capital`：初始资金（默认100万港元）
- `analysis_frequency`：执行频率（默认每60分钟执行一次交易分析）

不同投资者类型的风险偏好设置：
- 保守型：偏好低风险、稳定收益的股票，如高股息银行股，注重资本保值
- 平衡型：平衡风险与收益，兼顾价值与成长，追求稳健增长
- 进取型：偏好高风险、高收益的股票，如科技成长股，追求资本增值

资金分配策略由大模型根据投资者风险偏好确定，系统不再使用预设的投资比例限制，而是完全依赖大模型建议的资金分配比例进行投资，以避免过度集中投资。

### 个股新闻获取器参数
在`batch_stock_news_fetcher.py`文件中可以使用以下参数：

- `--schedule` 或 `-s`：启用定时任务模式（默认：单次运行）
- 定时任务模式下，程序会在香港时间上午9点和下午1点半各运行一次

## 信号说明

### 建仓信号
当股价处于相对低位、成交量显著放大、南向资金净流入超过阈值，且满足至少一个辅助技术指标条件时触发。

### 出货信号
当股价处于相对高位、成交量剧烈放大、南向资金净流出超过阈值，且满足至少一个辅助技术指标条件时触发。

## 输出文件

### 数据获取组件
- 控制台输出：价格信息预览
- 邮件报告：包含详细的价格信息和IPO信息
- CSV文件：保存个股新闻数据

### 分析组件
- Excel报告：详细的分析结果
- 可视化图表：保存在hk_smart_charts目录下
- 邮件报告：包含详细指标说明和分析结果
- CSV文件：保存个股新闻数据

### 模拟交易系统
- 状态文件：data/simulation_state.json（保存交易状态，支持中断后继续）
- 交易日志：data/simulation_trade_log_*.txt（详细交易日志记录，按日期分割）
- 交易历史：data/simulation_transactions.csv（交易历史记录）
- 投资组合历史：data/simulation_portfolio.csv（投资组合价值变化记录）
- 邮件通知：包括买入通知、卖出通知、无法买入/卖出通知、自动交易通知等，所有通知邮件均包含大模型建议的买卖原因
- 每日总结：每日收盘后生成交易总结报告

## 自动化调度

项目支持多种自动化调度方式：

1. **GitHub Actions调度**：
   - **加密货币价格监控**：默认每天UTC时间0:00、8:00和16:00执行（即北京时间8:00、16:00和0:00）
   - **港股IPO信息获取**：默认每天UTC时间1:00执行（即北京时间9:00）
   - **黄金市场分析**：默认每天UTC时间7:00执行（即北京时间15:00）

2. **本地定时执行**：
   - 通过`send_alert.sh`脚本实现本地定时执行主力资金追踪和黄金分析
   - 可通过crontab配置执行时间

3. **模拟交易系统**：
   - 可在本地运行，支持长时间模拟交易测试
   - 每60分钟执行一次交易分析

## 注意事项

- 本工具仅用于数据分析和参考，不构成投资建议
- 投资者应结合基本面分析和风险管理进行决策
- 南向资金数据可能存在延迟或不准确的情况
- 建议定期更新依赖库以获取最新数据
- 爬虫功能可能因网站结构变化而失效，需要及时调整
- 模拟交易系统仅用于验证交易策略，不保证实际交易效果

## 项目维护

本项目持续更新和改进，包括：
- 修复已知问题和错误
- 优化代码性能和可读性
- 添加新的金融分析功能
- 集成更多数据源和API
- 改进大模型集成和交易策略
- 增强自动化和通知功能