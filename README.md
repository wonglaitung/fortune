# 港股智能分析与交易系统

**⭐ 如果您觉得这个项目有用，请先给项目STAR再FORK，以支持项目发展！⭐**

一个基于 Python 的生产级港股智能分析系统，集成11个数据源、CatBoost机器学习模型和大模型智能决策。CatBoost单模型回测收益率238.76%（置信度0.55，86%优秀股票），支持实时技术指标、板块轮动分析、综合买卖建议和自动化调度，为投资者提供全面的市场分析和交易策略验证工具。

## 📋 Table of Contents
- [项目简介](#项目简介)
- [核心功能](#核心功能)
- [机器学习模型](#机器学习模型)
- [快速开始](#快速开始)
- [项目结构](#项目结构)
- [技术架构](#技术架构)
- [使用示例](#使用示例)
- [综合分析系统](#综合分析系统)
- [自动化调度](#自动化调度)
- [性能数据](#性能数据)
- [注意事项](#注意事项)
- [未来计划](#未来计划)

## 项目简介

本项目旨在帮助投资者：

- 📊 实时监控加密货币、港股、黄金等金融市场
- 🔍 识别主力资金动向和交易信号
- 🤖 基于大模型进行智能投资决策和持仓分析
- 📈 验证交易策略的有效性
- 💰 获取股息信息和基本面数据
- 📧 自动邮件通知重要信息
- 🎯 获取每日综合买卖建议（整合大模型和ML预测）
- 🔄 批量回测所有股票，全面评估模型表现
- 📊 **恒生指数涨跌预测**：基于特征重要性的加权评分模型
- 📋 **模拟交易记录展示**：最近48小时模拟交易记录（表格格式）

## 核心功能

### 数据获取与监控
- **加密货币监控**：比特币、以太坊价格和技术分析（每小时）
- **港股IPO信息**：最新IPO信息（每天）
- **黄金市场分析**：黄金价格和投资建议（每小时）
- **恒生指数监控**：价格、技术指标、交易信号（交易时段）
- **恒生指数涨跌预测**：基于特征重要性的加权评分模型，预测短期走势
- **美股市场数据**：标普500、纳斯达克、VIX、美国国债收益率
- **基本面数据**：财务指标、利润表、资产负债表、现金流量表
- **股息信息**：自动获取股息和除净日信息

### 智能分析
- **主力资金追踪**：识别建仓和出货信号，集成基本面分析
- **板块分析**：16个板块涨跌幅排名、技术趋势分析、龙头识别
- **板块轮动河流图**：可视化板块排名变化
- **恒生指数策略**：大模型生成交易策略
- **AI交易分析**：复盘AI推荐策略有效性
- **综合分析系统（每日自动执行）**：整合大模型建议和CatBoost预测结果，生成实质买卖建议
- **模拟交易记录展示**：最近48小时模拟交易记录（表格格式）

### 模拟交易
- **真实模拟**：基于大模型建议的模拟交易系统
- **风险控制**：自动止损机制
- **详细记录**：完整的交易日志和持仓分析
- **多种策略**：支持保守型、平衡型、进取型投资偏好

## 机器学习模型

### 模型架构
- **CatBoost 单模型**：CatBoost 20天模型（当前主要使用）⭐
- **多周期预测**：预测1天、5天、20天后的涨跌
- **特征工程**：2991个特征（技术指标、基本面、美股市场、情感指标、板块分析、长期趋势、主题分布、主题情感交互、预期差距）
- **特征选择**：使用500个精选特征（statistical方法：F-test+互信息混合）

### CatBoost 模型优势
- 自动处理分类特征，无需手动编码
- 更好的默认参数，减少调参工作量
- 更快的训练速度，支持GPU加速
- 更好的泛化能力，减少过拟合
- 稳定性显著提升（±1.95% vs LightGBM ±3.50%，提升44.3%）

### 批量回测功能
- 对自选股列表中的所有股票（28只）进行批量回测
- 支持单一模型批量回测
- 支持不同置信度阈值（0.55、0.60等）
- 生成汇总报告，包含平均表现和排名
- 支持股票名称显示

## 快速开始

### 环境要求
- Python 3.10 或更高版本
- pip 包管理器

### 安装步骤

```bash
# 1. 克隆项目
git clone https://github.com/wonglaitung/fortune.git
cd fortune

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置环境变量
# 编辑 set_key.sh 文件，设置邮件和大模型API密钥
source set_key.sh
```

## 项目结构

```
fortune/
├── 核心脚本
│   ├── ai_trading_analyzer.py          # AI交易分析器
│   ├── crypto_email.py                 # 加密货币监控器
│   ├── gold_analyzer.py                # 黄金市场分析器
│   ├── hk_ipo_aastocks.py              # IPO信息获取器
│   ├── hk_smart_money_tracker.py       # 主力资金追踪器
│   ├── hsi_email.py                    # 恒生指数监控器
│   ├── hsi_prediction.py               # 恒生指数涨跌预测器
│   ├── simulation_trader.py            # 模拟交易系统
│   ├── comprehensive_analysis.py       # 综合分析脚本（每日自动执行）
│   └── ...
│
├── 数据服务模块 (data_services/)
│   ├── technical_analysis.py           # 通用技术分析工具
│   ├── fundamental_data.py             # 基本面数据获取器
│   ├── hk_sector_analysis.py           # 板块分析器
│   └── ...
│
├── 机器学习模块 (ml_services/)
│   ├── ml_trading_model.py             # 机器学习交易模型
│   ├── batch_backtest.py               # 批量回测脚本
│   ├── backtest_evaluator.py           # 回测评估模块
│   ├── us_market_data.py               # 美股市场数据
│   ├── feature_selection.py            # 特征选择模块
│   ├── topic_modeling.py               # LDA主题建模模块
│   ├── lstm_experiment.py              # LSTM对比实验脚本
│   ├── BACKTEST_GUIDE.md               # 回测功能使用指南
│   └── ...
│
├── 大模型服务 (llm_services/)
│   ├── qwen_engine.py                  # Qwen大模型接口
│   └── sentiment_analyzer.py           # 情感分析模块
│
├── 配置文件
│   ├── config.py                       # 全局配置
│   ├── requirements.txt                # 项目依赖
│   ├── run_comprehensive_analysis.sh   # 综合分析自动化脚本
│   ├── set_key.sh                      # 环境变量配置
│   └── .github/workflows/              # GitHub Actions工作流配置
│       ├── batch-stock-news-fetcher.yml     # 批量股票新闻获取
│       ├── comprehensive-analysis.yml       # 综合分析邮件
│       ├── daily-ai-trading-analysis.yml    # AI交易分析日报
│       ├── daily-ipo-monitor.yml            # IPO信息监控
│       ├── hourly-crypto-monitor.yml        # 每小时加密货币监控
│       ├── hourly-gold-monitor.yml          # 每小时黄金监控
│       ├── hsi-prediction.yml               # 恒生指数涨跌预测
│       ├── weekly-comprehensive-analysis.yml # 周综合交易分析
│       └── ...
│
├── 输出文件 (output/)
│   ├── batch_backtest_*.json           # 批量回测详细数据
│   ├── batch_backtest_summary_*.txt    # 批量回测汇总报告
│   └── ...
│
└── 数据文件 (data/)
    ├── actual_porfolio.csv             # 实际持仓数据
    ├── llm_recommendations_*.txt       # 大模型建议文件
    ├── ml_trading_model_catboost_predictions_20d.csv  # CatBoost预测结果
    ├── comprehensive_recommendations_*.txt  # 综合买卖建议文件
    ├── model_accuracy.json             # 模型准确率信息
    └── ...
```

## 技术架构

```
金融信息监控与智能交易系统
│
├── 数据获取层
│   ├── 加密货币数据 (CoinGecko)
│   ├── 港股数据 (yfinance, 腾讯财经, AKShare)
│   ├── 黄金数据 (yfinance)
│   ├── 基本面数据 (AKShare)
│   └── 美股市场数据 (yfinance)
│
├── 数据服务层
│   ├── 技术分析 (RSI、MACD、布林带、ATR等)
│   ├── 基本面分析
│   ├── 板块分析
│   └── 新闻过滤
│
├── 分析层
│   ├── 主力资金追踪
│   ├── AI交易分析
│   ├── 机器学习模型
│   │   ├── CatBoost 单模型（主要使用）
│   │   ├── LightGBM 模型
│   │   ├── GBDT 模型
│   │   ├── LSTM 模型（对比实验）
│   │   └── 批量回测（28只股票）
│   └── 综合分析（每日自动执行）
│
├── 交易层
│   └── 模拟交易系统
│
└── 服务层
    ├── 大模型服务
    └── 邮件服务
```

## 使用示例

### 训练和预测

```bash
# 监控加密货币价格
python crypto_email.py

# 追踪港股主力资金
python hk_smart_money_tracker.py

# 板块分析
python data_services/hk_sector_analysis.py

# 恒生指数价格监控
python hsi_email.py

# 恒生指数涨跌预测
python hsi_prediction.py

# 恒生指数涨跌预测（不发送邮件）
python hsi_prediction.py --no-email

# 启动模拟交易
python simulation_trader.py

# 训练 CatBoost 模型（推荐）
python ml_services/ml_trading_model.py --mode train --horizon 20 --model-type catboost --use-feature-selection --skip-feature-selection

# 生成 CatBoost 预测
python ml_services/ml_trading_model.py --mode predict --horizon 20 --model-type catboost

# 批量回测所有股票（28只）
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.55
python3 ml_services/batch_backtest.py --model-type lgbm --horizon 20 --use-feature-selection --confidence-threshold 0.55
python3 ml_services/batch_backtest.py --model-type gbdt --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 批量回测结果会保存到：
# - output/batch_backtest_{model_type}_{horizon}d_{timestamp}.json（详细数据）
# - output/batch_backtest_summary_{model_type}_{horizon}d_{timestamp}.txt（汇总报告）
```

### 综合分析

```bash
# 一键执行完整流程
./run_comprehensive_analysis.sh

# 或手动执行
python comprehensive_analysis.py

# 不发送邮件
python comprehensive_analysis.py --no-email
```

## 综合分析系统

### 功能说明
整合大模型建议（短期和中期）与 CatBoost 单模型预测结果（20天），进行综合对比分析，生成实质的买卖建议。

### 执行流程
1. **步骤0**：运行特征选择（statistical方法，生成500个精选特征）- 只执行一次
2. **步骤1**：训练 CatBoost 20天模型（使用步骤0的特征，跳过特征选择）
3. **步骤2**：生成 CatBoost 单模型预测
4. **步骤3**：生成大模型建议（短期和中期）
5. **步骤4**：综合对比分析（整合大模型建议和CatBoost预测）
6. **步骤5**：生成详细的综合买卖建议
7. **步骤6**：发送邮件通知（每日自动发送）

### 邮件内容（信息参考部分）
1. **# 信息参考**
2. **## 一、机器学习预测结果（20天）**（CatBoost 单模型，显示全部28只股票及预测方向）
3. **## 二、大模型建议**（短期和中期买卖建议）
4. **## 三、实时技术指标**（恒生指数及自选股实时技术指标）
5. **## 四、最近48小时模拟交易记录**（表格格式）
6. **## 五、板块分析（5日涨跌幅排名）**
7. **## 六、股息信息（即将除净）**
8. **## 七、恒生指数技术分析**
9. **## 八、股票技术指标详情**
10. **## 九、恒生指数涨跌预测**
11. **## 十、技术指标说明**
12. **## 十一、决策框架**
13. **## 十二、风险提示**
14. **## 十三、数据来源**

### CatBoost 预测结果展示
- 显示全部28只股票的 CatBoost 预测结果
- 添加"预测方向"栏位（上涨/下跌）
- 添加"预测概率"栏位
- 添加"置信度"栏位（高/中/低）
- 预测概率分类：
  - **高置信度上涨**：prediction_probability > 0.60
  - **中等置信度上涨**：0.50 < prediction_probability ≤ 0.60
  - **预测下跌**：prediction_probability ≤ 0.50

### 信号稀释问题分析

**问题描述**：
尽管所有模型在训练集上的准确率相似（~60%），但在实际回测中表现差异巨大：
- CatBoost 单模型：238.76% 收益率，夏普比率 1.51
- GBDT 单模型：-1.86% 收益率，夏普比率 -0.06
- LightGBM 单模型：-8.22% 收益率，夏普比率 -0.18
- 融合模型（加权平均）：-4.72% 收益率，夏普比率 -0.05

**根本原因：信号质量差异**
- CatBoost 识别出的是**高质量的强信号**（真实可交易信号）
- GBDT/LightGBM 识别出的是**低质量的弱信号**（噪声）
- 融合模型将强信号与弱信号混合，导致**强信号被稀释**

**CatBoost 为什么能识别强信号**：
1. **Ordered Boosting 算法**：减少训练集-验证集信息泄露，提升泛化能力
2. **自动分类特征处理**：使用 Ordered Target Statistics 避免 Target Leakage
3. **更好的正则化配置**：depth=7, learning_rate=0.05, l2_leaf_reg=3
4. **更强的特征交互学习能力**：能够捕捉市场环境特征与技术指标的复杂交互
5. **更好的泛化能力和稳定性**：在不同股票上的表现更加稳定一致（86%优秀股票）

**验证结果：融合方法均失败**
- DynamicMarketStrategy（动态市场策略）：收益率 0.50%（失败）
- AdvancedDynamicStrategy（高级动态策略）：收益率 -0.29%（失败）
- 融合模型（加权平均）：收益率 -4.72%（失败）
- 融合模型（简单平均）：收益率 -0.06%（失败）
- 融合模型（投票机制）：收益率 -0.12%（失败）

**结论**：
- ❌ 所有融合方法均失败
- ❌ 无法通过动态权重或市场 regime 检测解决问题
- ✅ 使用 CatBoost 单模型是最优解
- ✅ 特征选择使用 statistical 方法（F-test+互信息混合）

## 自动化调度

系统使用 GitHub Actions 进行自动化调度：

| 工作流 | 功能 | 执行时间 |
|--------|------|----------|
| hourly-crypto-monitor.yml | 每小时加密货币监控 | 每小时 |
| hourly-gold-monitor.yml | 每小时黄金监控 | 每小时 |
| hsi-prediction.yml | **恒生指数涨跌预测** | **周一到周五 UTC 22:00（香港时间上午6:00）** |
| comprehensive-analysis.yml | **综合分析邮件** | **周一到周五 UTC 08:00（香港时间下午4:00）** |
| batch-stock-news-fetcher.yml | 批量股票新闻获取 | 每天 UTC 22:00 |
| daily-ipo-monitor.yml | IPO 信息监控 | 每天 UTC 02:00 |
| daily-ai-trading-analysis.yml | AI 交易分析日报 | 周一到周五 UTC 08:30 |
| weekly-comprehensive-analysis.yml | 周综合交易分析 | 每周日 UTC 01:00（香港时间上午9:00） |

## 性能数据

### 最新准确率与F1分数

| 预测周期 | 模型 | 准确率 | F1分数 | 说明 |
|---------|------|--------|--------|------|
| 次日（1天） | LightGBM | 50.91%（±1.07%） | 0.4995 | - |
| | GBDT | 53.56%（±1.80%） | 0.5151 | - |
| | CatBoost | 65.10%（±5.63%）❌ | 0.6361 | **CatBoost 1天模型存在过拟合风险，不推荐使用** |
| | LSTM | 51.81%（±0.78%） | 0.0000 | LSTM模型在精确率、召回率方面有待提升 |
| 一周（5天） | LightGBM | 55.12%（±2.17%） | 0.6924 | - |
| | GBDT | 55.31%（±2.45%） | 0.6943 | - |
| | CatBoost | 63.96%（±4.22%）⚠️ | 0.6785 | CatBoost 5天模型需要更多验证 |
| | LSTM | 48.67%（±1.83%） | 0.0000 | LSTM 5天预测准确率略低于随机水平 |
| 一个月（20天） | LightGBM | 58.37%（±3.50%） | 0.7151 | - |
| | GBDT | 58.91%（±4.00%） | 0.7146 | - |
| | CatBoost | **60.94%（±1.95%）** ⭐ | 0.6823 | **CatBoost 20天达到业界顶尖水平** |
| | LSTM | 51.18%（±2.20%） | 0.2345 | LSTM 20天预测F1分数有所提升 |

### 批量回测性能（置信度0.55）

**CatBoost 20天（推荐）：**
- 平均总收益率：238.76%
- 夏普比率：1.51
- 胜率：32.81%
- 优秀股票占比：86%（24/28）

**其他模型对比：**
- GBDT 20天：平均总收益率-1.86%，夏普比率-0.06，胜率29.88%
- LightGBM 20天：平均总收益率-8.22%，夏普比率-0.18，胜率29.57%

### CatBoost 批量回测详细表现（置信度0.55，28只股票）
- 最高收益率：1353.20%（1347.HK 华虹半导体）
- 最低收益率：9.45%（0941.HK 中国移动）
- 收益率中位数：160.12%
- 收益率标准差：259.76%
- **优秀股票（收益率>50%）**：24只（86%）
- **一般股票（收益率20-50%）**：3只（11%）
- **表现不佳（收益率<20%）**：1只（0941.HK 中国移动 9.45%）

### CatBoost 核心优势

1. **自动分类特征处理**：使用 Ordered Target Statistics 避免 Target Leakage
2. **Ordered Boosting 算法**：减少训练集-验证集信息泄露，提升泛化能力
3. **更好的正则化配置**：depth=7, learning_rate=0.05, l2_leaf_reg=3
4. **更强的特征交互学习能力**：能够捕捉市场环境特征与技术指标的复杂交互
5. **更好的泛化能力和稳定性**：在不同股票上的表现更加稳定一致

### LSTM模型F1分数分析
- **1天预测**: 所有股票的F1分数均为0.0000，精确率和召回率均为0.0000
- **5天预测**: 所有股票的F1分数均为0.0000，精确率和召回率均为0.0000
- **20天预测**: F1分数有所改善，0939.HK (建行) 达到0.7034，平均F1分数为0.2345（±0.3316）
- **主要原因**: LSTM模型预测结果偏向单一类别，需要进一步优化阈值设置或训练策略

## 项目状态

| 维度 | 状态 | 说明 |
|------|------|------|
| **核心功能** | ✅ 完整 | 数据获取、分析、交易、通知全覆盖 |
| **恒生指数预测** | ✅ 完整 | 基于特征重要性的加权评分模型 |
| **LSTM对比实验** | ✅ 完整 | 基于PyTorch的LSTM模型与传统模型对比 |
| **F1分数指标** | ✅ 完整 | 模型性能评估中加入F1分数指标 |
| **模块化架构** | ✅ 完成 | data_services、llm_services、ml_services |
| **ML模型** | ✅ 顶尖 | CatBoost 20天准确率60.94%，达到业界顶尖水平 |
| **批量回测** | ✅ 完整 | 支持28只股票批量回测 |
| **综合分析** | ✅ 稳定 | 每日自动执行，整合大模型建议和CatBoost预测 |
| **交易记录展示** | ✅ 完整 | 最近48小时模拟交易记录以表格格式展示 |
| **实时指标集成** | ✅ 完整 | 集成 hsi_email.py 的实时技术指标 |
| **自动化** | ✅ 稳定 | 9个GitHub Actions工作流正常运行 |
| **文档** | ✅ 完整 | README、AGENTS、BACKTEST_GUIDE齐全 |
| **数据验证** | ✅ 严格 | 无数据泄漏，时间序列交叉验证 |
| **风险管理** | ⚠️ 可优化 | 可添加VaR、ES、压力测试 |
| **Web界面** | ❌ 未实现 | 可考虑添加可视化界面 |

## 依赖项

```txt
yfinance        # 金融数据获取
requests        # HTTP请求
pandas          # 数据处理
numpy           # 数值计算
akshare         # 中文财经数据
matplotlib      # 数据可视化
lightgbm        # 机器学习模型（LightGBM）
catboost        # 机器学习模型（CatBoost）⭐ 主要模型
scikit-learn    # 机器学习工具库
jieba           # 中文分词
nltk            # 自然语言处理
torch           # PyTorch深度学习框架（LSTM模型）
```

## 注意事项

1. **模型性能基准**：
   - 随机/平衡基线：≈50%
   - 常见弱信号：≈51-55%
   - 有意义的改进：≈55-60%
   - 非常好/罕见：≈60-65%
   - 异常高（需怀疑）：>65%

2. **F1分数评估**：
   - F1分数综合评估精确率和召回率
   - LSTM模型1天和5天预测F1分数为0.0000，需要优化
   - LSTM模型20天预测F1分数有所改善，达到0.2345（±0.3316）

3. **数据验证**：
   - 严格的时间序列交叉验证
   - 无数据泄漏
   - 日期索引保留，按时间顺序排列

4. **重要警告**：
   - **CatBoost 1天模型存在严重过拟合风险**：准确率65.10%（±5.63%），标准偏差过高
   - **不推荐使用 CatBoost 1天模型的预测结果**
   - **推荐使用 CatBoost 20天模型作为主要预测来源**

5. **置信度阈值选择**：
   - 保守型投资者：0.60-0.65（风险控制优先）
   - 平衡型投资者：0.55（收益与风险平衡）⭐ 推荐
   - 进取型投资者：0.50-0.55（追求更高收益）

6. **数据源限制**：部分数据源可能有访问频率限制
7. **缓存机制**：基本面数据缓存7天，可手动清除
8. **交易时间**：模拟交易系统遵循港股交易时间
9. **风险提示**：本系统仅供学习和研究使用，不构成投资建议
10. **API密钥**：请妥善保管API密钥，不要提交到版本控制

## 未来计划

### 已完成

**机器学习模型优化**：
- ✅ 特征工程：2991个特征（技术指标、基本面、美股市场、情感指标、板块分析、长期趋势、主题分布、主题情感交互、预期差距）
- ✅ 特征选择：使用500个精选特征（statistical方法：F-test+互信息混合）
- ✅ GBDT模型重构：移除GBDT+LR两层结构，准确率提升3.21%，稳定性提升40.6%
- ✅ **CatBoost算法集成**：新增CatBoost模型，准确率60.94%（±1.95%），稳定性提升44.3%
- ✅ **F1分数指标集成**：为ML模型添加F1分数计算，全面评估精确率和召回率
- ✅ 动态准确率加载：训练时自动保存准确率，分析时自动读取
- ✅ 回测评估功能：验证模型盈利能力（置信度阈值 0.55）
- ✅ **批量回测功能**：支持28只股票批量回测，全面评估模型表现
- ✅ **CatBoost 单模型策略**：放弃融合模型，使用 CatBoost 单模型（回测收益率238.76%）

**恒生指数预测**：
- ✅ **恒生指数涨跌预测器**：基于特征重要性的加权评分模型，预测短期走势

**综合分析系统**：
- ✅ 整合大模型建议和 CatBoost 单模型预测结果
- ✅ 动态准确率加载功能
- ✅ 板块分析、股息信息、恒生指数技术分析
- ✅ 推荐股票技术指标详情
- ✅ **CatBoost 预测结果展示**：显示预测方向、预测概率、置信度
- ✅ **实时技术指标集成**：从 hsi_email.py 获取恒生指数及自选股实时技术指标
- ✅ **模拟交易记录展示**：最近48小时模拟交易记录（表格格式）
- ✅ 每日自动执行，发送综合邮件

### 待实现

**高优先级**：
- 风险管理模块（VaR、止损止盈、仓位管理）
- 投资组合优化算法

**中优先级**：
- 机器学习模型自动超参数调优
- ML预测结果可视化优化

**低优先级**：
- Web界面
- 深度学习模型（LSTM、Transformer）
- 实时数据流处理

### 完成度统计

| 分类 | 完成率 |
|------|--------|
| ML特征工程优化 | 100% |
| CatBoost单模型 | 100% |
| 综合分析系统 | 100% |
| 回测评估功能 | 100% |
| 批量回测功能 | 100% |
| 实时指标集成 | 100% |
| 交易记录展示 | 100% |
| 模拟交易记录表格化 | 100% |
| 工作流优化 | 100% |
| 恒生指数涨跌预测 | 100% |
| 风险管理模块 | 0% |
| 其他功能 | 17% |
| **总体** | **95%** |

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License

## 联系方式

如有问题，请提交 Issue 或联系项目维护者。

联系邮件：wonglaitung@gmail.com