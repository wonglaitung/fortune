# 金融信息监控与模拟交易系统

## 项目简介

本项目是一个综合性的金融信息监控与模拟交易系统，旨在为投资者提供全面的市场分析和交易策略验证工具。系统集成了多种金融数据源，利用技术分析、资金流向分析和大模型智能判断，帮助用户更好地理解市场动态并验证投资策略。

系统包含十二个核心组件：
1. **加密货币价格监控器** - 实时获取主流加密货币的价格信息并通过邮件发送
2. **港股IPO信息获取器** - 爬取AAStocks网站获取最新的港股IPO信息
3. **港股主力资金追踪器** - 分析港股市场主力资金动向，识别建仓和出货信号
4. **港股主力资金历史数据分析器** - 分析历史数据中的信号模式
5. **港股模拟交易系统** - 基于主力资金追踪器的分析结果和大模型判断进行模拟交易
6. **批量获取自选股新闻** - 获取自选股相关的最新财经新闻并使用大模型分析相关性
7. **黄金市场分析器** - 分析黄金市场价格趋势和技术指标
8. **恒生指数大模型策略分析器** - 通过腾讯财经API获取恒生指数数据并进行大模型策略分析
9. **恒生指数价格监控器** - 基于技术分析指标生成恒生指数交易信号，只在有信号时发送邮件
10. **最近48小时连续交易信号分析器** - 分析最近48小时内连续买入/卖出同一只股票的信号
11. **通用技术分析工具** - 提供多种常用技术指标计算功能（移动平均线、RSI、MACD、布林带等）
12. **腾讯财经数据接口** - 提供更稳定和准确的港股及恒生指数数据

## 系统架构

```
金融信息监控与模拟交易系统
├── 数据获取层
│   ├── 加密货币价格监控器 (@crypto_email.py)
│   ├── 港股IPO信息获取器 (@hk_ipo_aastocks.py)
│   ├── 黄金市场分析器 (@gold_analyzer.py)
│   ├── 恒生指数大模型策略分析器 (@hsi_llm_strategy.py)
│   └── 恒生指数价格监控器 (@hsi_email.py)
├── 分析层
│   ├── 港股主力资金追踪器 (@hk_smart_money_tracker.py)
│   ├── 港股主力资金历史数据分析 (@hk_smart_money_historical_analysis.py)
│   ├── 批量获取自选股新闻 (@batch_stock_news_fetcher.py)
│   ├── 最近48小时连续交易信号分析器 (@analyze_last_48_hours_email.py)
│   └── 通用技术分析工具 (@technical_analysis.py)
├── 交易层
│   └── 港股模拟交易系统 (@simulation_trader.py)
└── 服务层
    ├── 大模型服务 (@llm_services/qwen_engine.py)
    └── 腾讯财经数据接口 (@tencent_finance.py)
```

## 核心功能

### 1. 数据获取与监控
- **实时数据获取**：获取加密货币和港股市场的实时价格数据
- **网络爬虫**：从AAStocks等网站获取IPO信息
- **新闻获取**：获取自选股相关的最新财经新闻
- **自动邮件通知**：将重要信息通过邮件发送给用户，采用统一的表格化样式展示

### 2. 技术分析工具
- **通用技术分析工具**：集成多种常用技术指标（移动平均线、RSI、MACD、布林带、随机振荡器、ATR、CCI、OBV等）
- **趋势分析**：基于均线排列分析市场趋势（强势多头、多头趋势、弱势空头、空头趋势、震荡整理、短期趋势）
- **买卖信号生成**：基于技术指标组合生成买入卖出信号（金叉死叉、RSI超买超卖、布林带突破等）
- **技术指标计算原理**：
  - **移动平均线（MA）**：通过计算指定周期内价格的平均值来平滑价格走势，显示价格趋势方向
  - **相对强弱指数（RSI）**：通过比较价格上涨和下跌的幅度来衡量价格动量，判断超买超卖状态
  - **移动平均收敛发散指标（MACD）**：通过计算两条不同周期的指数移动平均线的差值及其信号线，识别价格动量和趋势变化
  - **布林带（Bollinger Bands）**：通过计算价格的标准差来构建价格通道，识别价格波动范围和突破机会
  - **随机振荡器（Stochastic Oscillator）**：通过比较收盘价与一定周期内的价格范围来衡量价格动量
  - **平均真实波幅（ATR）**：通过计算价格波动的真实范围来衡量市场波动性
  - **商品通道指数（CCI）**：通过比较价格与其统计平均值来识别周期性趋势
  - **能量潮指标（OBV）**：通过累计成交量来衡量资金流向和市场动力

### 3. 智能分析
- **技术指标分析**：MACD、RSI、OBV、均线等技术指标计算
- **资金流向分析**：沪港通/深港通南向资金数据获取与分析
- **信号识别**：自动识别主力资金建仓和出货信号
- **历史数据分析**：分析历史数据中的信号模式
- **新闻分析**：利用大模型分析新闻与股票的相关性
- **黄金市场分析**：获取黄金相关资产和宏观经济数据，进行技术分析
- **恒生指数策略分析**：获取恒生指数数据并进行大模型策略分析
- **最近48小时连续交易信号分析**：分析最近48小时内连续买入/卖出同一只股票的信号
- **通用技术分析工具**：集成多种技术指标计算功能，提供全面的市场分析能力

### 4. 模拟交易
- **大模型集成**：真实调用大模型进行股票分析和交易决策
- **结构化输出**：要求大模型以固定JSON格式输出买卖信号
- **风险偏好支持**：支持保守型、平衡型、进取型投资者设置
- **严格遵循**：严格按照大模型建议执行交易，无随机操作
- **状态持久化**：交易记录和状态自动保存，支持中断后继续
- **交易通知**：在无法按大模型建议执行交易时发送邮件通知
- **自动盈亏管理**：根据投资者类型和盈亏比例自动执行买卖操作
- **智能持仓管理**：动态跟踪持仓盈亏情况，根据大模型建议的止损价格自动止损
- **详细持仓展示**：提供详细的持仓信息，包括股票代码、名称、持有数量、平均成本、当前价格、持有金额、盈亏金额等
- **每日总结报告**：每日收盘后生成交易总结报告
- **手工交易支持**：支持手动执行卖出操作
- **邮件通知系统**：完善的邮件通知系统，包括买入、卖出、自动交易等各类通知

## 安装与配置

### 安装依赖

```bash
# 基础依赖
pip install requests beautifulsoup4 pandas

# 港股分析组件依赖
pip install yfinance akshare pandas matplotlib openpyxl scipy schedule

# 模拟交易系统依赖
pip install schedule

# 黄金分析器依赖
pip install yfinance pandas numpy

# 新闻获取器依赖
pip install yfinance

# 技术分析工具依赖
pip install yfinance pandas numpy

# 恒生指数策略分析器依赖
pip install yfinance pandas numpy
```

### 环境变量配置

设置以下环境变量以启用邮件发送功能和大模型服务：

- `YAHOO_EMAIL`：发件人邮箱地址
- `YAHOO_APP_PASSWORD`：发件人邮箱应用密码
- `RECIPIENT_EMAIL`：收件人邮箱地址（可选，多个收件人用逗号分隔）
- `QWEN_API_KEY`：大模型API密钥（用于模拟交易系统、资金追踪器、新闻分析和恒生指数策略分析）
- `YAHOO_SMTP`：SMTP服务器地址（可选，默认为smtp.gmail.com）

## 组件详细说明

### 加密货币价格监控器 (@crypto_email.py)
- 实时获取比特币和以太坊的价格信息（USD和HKD）
- 支持获取24小时价格变化、市值和交易量
- 自动发送价格更新邮件，采用与黄金分析器一致的表格样式
- 支持多个收件人
- 包含详细的技术分析指标（RSI、MACD、均线等）
- 显示最近的交易信号（买入/卖出）
- 集成通用技术分析工具（@technical_analysis.py），提供全面的技术指标分析
- 只在检测到当天的交易信号时才发送邮件
- 通过GitHub Actions自动化调度（每小时执行一次，使用香港时区）

### 港股IPO信息获取器 (@hk_ipo_aastocks.py)
- 爬取AAStocks网站获取最新的港股IPO信息
- 提取公司名称、上市日期、行业、招股日期、每手股数、招股价格、入场费、暗盘日期等信息
- 保存IPO数据到CSV文件
- 发送IPO信息邮件
- 通过GitHub Actions自动化调度（每天UTC时间1:00执行，即北京时间9:00，使用香港时区）

### 港股主力资金追踪器 (@hk_smart_money_tracker.py)
- 实时获取港股股票价格和交易数据（使用腾讯财经接口获取更准确的数据）
- 分析股票的技术指标（MACD、RSI、均线偏离、OBV等）
- 获取沪港通/深港通南向资金数据
- 识别主力资金建仓和出货信号
- 生成可视化图表
- 发送详细分析报告邮件
- 结合个股相关新闻进行综合分析
- 支持本地定时执行脚本 `send_alert.sh`
- 集成通用技术分析工具（@technical_analysis.py），提供全面的技术指标分析
- 支持多股票同时分析和监控

### 港股主力资金历史数据分析 (@hk_smart_money_historical_analysis.py)
- 分析指定时间段内的历史数据
- 识别历史上的建仓和出货信号日期
- 生成历史信号报告Excel文件
- 支持自定义分析时间范围
- 提供历史信号回测分析功能

### 港股模拟交易系统 (@simulation_trader.py)
- 基于hk_smart_money_tracker的分析结果和大模型判断进行模拟交易
- 每60分钟执行一次交易分析（可通过参数调整）
- 真实调用大模型进行股票分析，并要求以固定JSON格式输出买卖信号
- 支持保守型、平衡型、进取型投资者风险偏好设置
- 严格按照"先卖后买"的原则执行交易
- 买入时优先考虑没有持仓的股票，同时支持对已有持仓股票的加仓
- 严格按照大模型建议的资金分配比例进行投资，避免过度集中投资
- 根据不同投资者类型自动进行盈亏比例交易
- 根据市场情况自动建议买入股票
- 在无法按大模型建议执行交易时（如资金不足或无持仓），会发送邮件通知
- 交易记录和状态自动保存，支持中断后继续
- 完整的交易日志记录（按日期分割）
- 详细的持仓详情展示和每日总结功能
- 支持手工执行卖出操作
- 将大模型建议的买卖原因添加到所有通知邮件中，使用户能够更好地理解交易决策的依据
- 实现了止损机制，根据大模型建议的止损价格自动执行止损操作
- 支持多种交易策略和风险控制机制

### 黄金市场分析器 (@gold_analyzer.py)
- 实时获取COMEX黄金期货和黄金ETF价格数据
- 计算技术指标（MACD、RSI、均线、布林带等）
- 分析黄金价格趋势和支撑阻力位
- 识别买卖信号
- 生成详细的分析报告
- 集成大模型深度分析黄金市场
- 支持本地定时执行脚本 `send_alert.sh`
- 集成通用技术分析工具（@technical_analysis.py），提供全面的技术指标分析
- 只在检测到当天的交易信号时才发送邮件
- 通过GitHub Actions自动化调度（每小时执行一次，使用香港时区）

### 恒生指数大模型策略分析器 (@hsi_llm_strategy.py)
- 通过腾讯财经API获取最新的恒生指数(HSI)数据
- 计算多种技术指标（移动平均线、RSI、MACD、布林带、波动率、量比等）
- 分析当前市场趋势（强势多头、多头趋势、弱势空头、空头趋势、震荡整理等）
- 调用大模型生成明确的交易策略建议
- 将策略分析报告保存到`data/hsi_strategy_latest.txt`文件
- 通过邮件发送策略分析报告
- 支持本地定时执行脚本 `send_alert.sh`
- 集成通用技术分析工具（@technical_analysis.py），提供全面的技术指标分析

### 恒生指数价格监控器 (@hsi_email.py)
- 实时获取恒生指数的价格和交易数据
- 计算技术指标（RSI、MACD、均线、布林带等）
- 识别买卖信号
- 只在检测到当天的交易信号时才发送邮件
- 通过GitHub Actions自动化调度（每小时执行一次，使用香港时区）
- 包含详细的技术分析指标和市场概览
- 发送交易信号提醒邮件，采用统一的表格样式展示

### 最近48小时连续交易信号分析器 (@analyze_last_48_hours_email.py)
- 分析最近48小时内连续买入/卖出同一只股票的信号
- 识别连续3次或以上建议买入同一只股票且期间没有卖出建议的情况
- 识别连续3次或以上建议卖出同一只股票且期间没有买入建议的情况
- 只在检测到符合条件的信号时发送邮件通知
- 通过GitHub Actions自动化调度（每小时执行一次，使用香港时区）

### 批量获取自选股新闻 (@batch_stock_news_fetcher.py)
- 获取自选股相关的最新财经新闻
- 使用yfinance库获取个股新闻数据（此前使用AKShare，现已改为yfinance以提高数据获取成功率）
- 利用大模型分析新闻与股票的相关性
- 按时间由近到远排列新闻
- 将新闻数据持久化保存到CSV文件
- 支持定时运行模式
- 提供新闻相关性评分和过滤功能

### 通用技术分析工具 (@technical_analysis.py)
- 提供多种常用技术指标计算功能（移动平均线、RSI、MACD、布林带等）
- 包含趋势分析算法，基于均线排列判断市场趋势
- 提供买卖信号生成机制，基于多种技术指标组合判断
- 为其他组件提供统一的技术分析接口
- 支持多种金融产品（股票、期货、外汇、加密货币等）的技术分析

### 港股模拟交易系统当前限制

目前模拟交易系统在执行层面仍保留一定的风险控制机制：

1. 系统会自动检查预期持仓比例是否超过大模型建议的比例，并在超过时自动调整买入数量或跳过交易
2. 这种执行层面的限制是为了控制风险，防止过度集中投资

### 港股模拟交易系统未来改进方向

为进一步提升系统的智能化水平，建议进行以下改进：

1. 在大模型提示词中强化风险控制要求，让大模型在生成买入建议时就充分考虑当前持仓情况和风险控制
2. 优化执行逻辑，使风险控制更加智能化，而不是简单的比例限制

### 腾讯财经数据接口 (@tencent_finance.py)
- 通过腾讯财经API获取港股股票数据
- 通过腾讯财经API获取恒生指数数据
- 提供更稳定和准确的港股数据源
- 作为备用数据源，提高数据获取的可靠性

## 使用方法

### 基础组件使用

```bash
# 加密货币价格监控器
python crypto_email.py

# 港股IPO信息获取器
python hk_ipo_aastocks.py

# 港股主力资金追踪器
python hk_smart_money_tracker.py

# 港股主力资金追踪器（指定日期分析）
python hk_smart_money_tracker.py --date 2025-10-25

# 港股主力资金历史数据分析
python hk_smart_money_historical_analysis.py --start-date 2025-01-01 --end-date 2025-09-30

# 黄金市场分析器
python gold_analyzer.py

# 黄金市场分析器（指定分析周期）
python gold_analyzer.py --period 6mo

# 恒生指数大模型策略分析器
python hsi_llm_strategy.py

# 恒生指数价格监控器
python hsi_email.py

# 最近48小时连续交易信号分析器
python analyze_last_48_hours_email.py

# 个股新闻获取器
python batch_stock_news_fetcher.py

# 个股新闻获取器（定时运行模式）
python batch_stock_news_fetcher.py --schedule
```

### 模拟交易系统使用

```bash
# 运行模拟交易系统（默认90天）
python simulation_trader.py

# 运行指定天数的模拟交易
python simulation_trader.py --duration-days 30

# 设置分析频率（默认每60分钟）
python simulation_trader.py --analysis-frequency 60

# 手工卖出指定股票（例如：卖出0700.HK腾讯控股）
python simulation_trader.py --manual-sell 0700.HK

# 手工卖出指定股票的部分仓位（例如：卖出50%）
python simulation_trader.py --manual-sell 0700.HK --sell-percentage 0.5
```

### 本地定时执行

项目包含 `send_alert.sh` 脚本，可用于本地定时执行主力资金追踪、黄金分析和恒生指数策略分析：

```bash
# 编辑 crontab
crontab -e

# 添加以下行以每天执行（请根据需要调整时间）
0 6 * * * /data/fortune/send_alert.sh
```

### 技术分析工具使用

```bash
# 直接运行技术分析工具
python technical_analysis.py

# 分析指定金融产品
# 在代码中修改symbols变量，然后运行
python technical_analysis.py
```

## 配置参数

### 港股主力资金追踪器参数
在`hk_smart_money_tracker.py`代码顶部可以调整以下参数：

- `WATCHLIST`：自选股票列表
- `DAYS_ANALYSIS`：分析窗口天数
- `VOL_WINDOW`：成交量分析窗口
- `PRICE_WINDOW`：价格分析窗口
- `BUILDUP_MIN_DAYS`：建仓信号最小确认天数
- `DISTRIBUTION_MIN_DAYS`：出货信号最小确认天数
- 阈值参数：
  - `PRICE_LOW_PCT`：建仓信号价格百分位阈值
  - `PRICE_HIGH_PCT`：出货信号价格百分位阈值
  - `VOL_RATIO_BUILDUP`：建仓信号量比阈值
  - `VOL_RATIO_DISTRIBUTION`：出货信号量比阈值
  - `SOUTHBOUND_THRESHOLD`：南向资金阈值

### 模拟交易系统参数
在`simulation_trader.py`文件中可以调整以下参数：

- `investor_type`：投资者风险偏好（"保守型"、"平衡型"、"进取型"）
- `initial_capital`：初始资金（默认100万港元）
- `analysis_frequency`：执行频率（默认每60分钟执行一次交易分析）

不同投资者类型的风险偏好设置：
- 保守型：偏好低风险、稳定收益的股票，如高股息银行股，注重资本保值
- 平衡型：平衡风险与收益，兼顾价值与成长，追求稳健增长
- 进取型：偏好高风险、高收益的股票，如科技成长股，追求资本增值

资金分配策略由大模型根据投资者风险偏好确定，系统会严格按照大模型建议的资金分配比例进行投资，同时保留一定的执行层面风险控制机制以避免过度集中投资。

### 个股新闻获取器参数
在`batch_stock_news_fetcher.py`文件中可以使用以下参数：

- `--schedule` 或 `-s`：启用定时任务模式（默认：单次运行）
- 定时任务模式下，程序会在香港时间上午9点和下午1点半各运行一次

## 信号说明

### 建仓信号
当股价处于相对低位、成交量显著放大、南向资金净流入超过阈值，且满足至少一个辅助技术指标条件时触发。

### 出货信号
当股价处于相对高位、成交量剧烈放大、南向资金净流出超过阈值，且满足至少一个辅助技术指标条件时触发。

### 输出文件

### 数据获取组件
- 控制台输出：价格信息预览
- 邮件报告：包含详细的价格信息和IPO信息，采用表格化展示，样式统一美观
- CSV文件：保存个股新闻数据

### 分析组件
- Excel报告：详细的分析结果
- 可视化图表：保存在hk_smart_charts目录下
- 邮件报告：包含详细指标说明和分析结果
- CSV文件：保存个股新闻数据
- 文本文件：恒生指数策略分析报告保存在`data/hsi_strategy_latest.txt`

### 模拟交易系统
- 状态文件：data/simulation_state.json（保存交易状态，支持中断后继续）
- 交易日志：data/simulation_trade_log_*.txt（详细交易日志记录，按日期分割）
- 交易历史：data/simulation_transactions.csv（交易历史记录）
- 投资组合历史：data/simulation_portfolio.csv（投资组合价值变化记录）
- 邮件通知：包括买入通知、卖出通知、无法买入/卖出通知、自动交易通知等，所有通知邮件均包含大模型建议的买卖原因
- 每日总结：每日收盘后生成交易总结报告
- 止损通知：当触发止损机制时，会发送止损通知邮件

## 自动化调度

项目支持多种自动化调度方式：

1. **GitHub Actions调度**：
   - **加密货币价格监控**：默认每小时执行一次（使用香港时区）
   - **港股IPO信息获取**：默认每天UTC时间1:00执行（即北京时间9:00，使用香港时区）
   - **黄金市场分析**：默认每小时执行一次（使用香港时区）
   - **港股主力资金追踪**：默认每天UTC时间22:00（即香港时间早上6:00）执行，现已整合个股新闻获取和恒生指数策略分析
   - **恒生指数价格监控**：默认每小时执行一次（使用香港时区）
   - **最近48小时连续交易信号分析**：默认每小时执行一次（使用香港时区）

2. **本地定时执行**：
   - 通过`send_alert.sh`脚本实现本地定时执行主力资金追踪、黄金分析和恒生指数策略分析
   - 可通过crontab配置执行时间
   - 批量获取自选股新闻支持定时运行模式

3. **模拟交易系统**：
   - 可在本地运行，支持长时间模拟交易测试
   - 每60分钟执行一次交易分析
   - 支持中断后继续执行

## 注意事项

- 本工具仅用于数据分析和参考，不构成投资建议
- 投资者应结合基本面分析和风险管理进行决策
- 南向资金数据可能存在延迟或不准确的情况
- 建议定期更新依赖库以获取最新数据
- 爬虫功能可能因网站结构变化而失效，需要及时调整
- 模拟交易系统仅用于验证交易策略，不保证实际交易效果


- 所有 GitHub Actions 工作流都设置为香港时区（Asia/Hong_Kong）
- 恒生指数价格监控的 GitHub Actions 工作流（.github/workflows/hsi-email-alert.yml）每小时执行一次
