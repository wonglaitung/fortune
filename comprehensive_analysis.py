#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç»¼åˆåˆ†æè„šæœ¬ - æ•´åˆå¤§æ¨¡å‹å»ºè®®å’ŒMLé¢„æµ‹ç»“æœ
ç”Ÿæˆç»¼åˆçš„ä¹°å–å»ºè®®
"""

import os
import sys
import argparse
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# å¯¼å…¥å¤§æ¨¡å‹æœåŠ¡
from llm_services.qwen_engine import chat_with_llm


def extract_llm_recommendations(filepath):
    """
    ä»å¤§æ¨¡å‹å»ºè®®æ–‡ä»¶ä¸­æå–ä¹°å–å»ºè®®
    
    å‚æ•°:
    - filepath: æ–‡ä»¶è·¯å¾„
    
    è¿”å›:
    - str: æå–çš„ä¹°å–å»ºè®®æ–‡æœ¬
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æå–ã€çŸ­æœŸå»ºè®®ã€‘éƒ¨åˆ†
        short_term_start = content.find("ã€çŸ­æœŸå»ºè®®ã€‘")
        if short_term_start != -1:
            short_term_end = content.find("\n\n", short_term_start + len("ã€çŸ­æœŸå»ºè®®ã€‘"))
            if short_term_end != -1:
                short_term_section = content[short_term_start:short_term_end]
            else:
                short_term_section = content[short_term_start:]
        else:
            short_term_section = ""
        
        # æå–ã€ä¸­æœŸå»ºè®®ã€‘éƒ¨åˆ†
        medium_term_start = content.find("ã€ä¸­æœŸå»ºè®®ã€‘")
        if medium_term_start != -1:
            medium_term_end = content.find("\n\n", medium_term_start + len("ã€ä¸­æœŸå»ºè®®ã€‘"))
            if medium_term_end != -1:
                medium_term_section = content[medium_term_start:medium_term_end]
            else:
                medium_term_section = content[medium_term_start:]
        else:
            medium_term_section = ""
        
        # æå–ä¹°å…¥å’Œå–å‡ºå»ºè®®
        buy_sell_recommendations = []
        
        # ä»çŸ­æœŸå»ºè®®ä¸­æå–
        if short_term_section:
            lines = short_term_section.split('\n')
            for line in lines:
                if 'ä¹°å…¥' in line or 'åŠ ä»“' in line or 'å–å‡º' in line or 'å‡ä»“' in line or 'æ¸…ä»“' in line:
                    buy_sell_recommendations.append(f"çŸ­æœŸ: {line.strip()}")
        
        # ä»ä¸­æœŸå»ºè®®ä¸­æå–
        if medium_term_section:
            lines = medium_term_section.split('\n')
            for line in lines:
                if 'æŒæœ‰' in line or 'åŠ ä»“' in line or 'å‡ä»“' in line or 'æ¸…ä»“' in line or 'ä¹°å…¥' in line or 'å–å‡º' in line:
                    buy_sell_recommendations.append(f"ä¸­æœŸ: {line.strip()}")
        
        recommendations_text = "\n".join(buy_sell_recommendations)
        return recommendations_text if recommendations_text else "æœªæ‰¾åˆ°ä¹°å–å»ºè®®"
        
    except Exception as e:
        print(f"âŒ æå–å¤§æ¨¡å‹å»ºè®®å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return ""


def extract_ml_predictions(filepath):
    """
    ä»MLé¢„æµ‹æ–‡ä»¶ä¸­æå–é¢„æµ‹ç»“æœ
    
    å‚æ•°:
    - filepath: æ–‡ä»¶è·¯å¾„
    
    è¿”å›:
    - str: æå–çš„é¢„æµ‹ç»“æœæ–‡æœ¬
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æå–é¢„æµ‹ç»“æœéƒ¨åˆ†
        predictions_start = content.find("ã€é¢„æµ‹ç»“æœã€‘")
        statistics_start = content.find("ã€ç»Ÿè®¡ä¿¡æ¯ã€‘")
        
        if predictions_start != -1:
            if statistics_start != -1:
                predictions_section = content[predictions_start:statistics_start]
            else:
                predictions_section = content[predictions_start:]
        else:
            predictions_section = ""
        
        # æå–é¢„æµ‹ä¸Šæ¶¨çš„è‚¡ç¥¨
        up_stocks = []
        lines = predictions_section.split('\n')
        for line in lines:
            if 'ä¸Šæ¶¨' in line and not line.startswith('è‚¡ç¥¨ä»£ç ') and not line.startswith('-'):
                up_stocks.append(line.strip())
        
        predictions_text = "\n".join(up_stocks[:10])  # åªå–å‰10ä¸ª
        return predictions_text if predictions_text else "æœªæ‰¾åˆ°é¢„æµ‹ä¸Šæ¶¨çš„è‚¡ç¥¨"
        
    except Exception as e:
        print(f"âŒ æå–MLé¢„æµ‹å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return ""


def send_email(subject, content, html_content=None):
    """
    å‘é€é‚®ä»¶é€šçŸ¥
    
    å‚æ•°:
    - subject: é‚®ä»¶ä¸»é¢˜
    - content: é‚®ä»¶æ–‡æœ¬å†…å®¹
    - html_content: é‚®ä»¶HTMLå†…å®¹ï¼ˆå¯é€‰ï¼‰
    """
    try:
        import smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        
        # ä»ç¯å¢ƒå˜é‡è·å–é‚®ä»¶é…ç½®
        sender_email = os.environ.get("YAHOO_EMAIL")
        email_password = os.environ.get("YAHOO_APP_PASSWORD")
        smtp_server = os.environ.get("YAHOO_SMTP", "smtp.163.com")
        recipient_email = os.environ.get("RECIPIENT_EMAIL", "wonglaitung@google.com")
        
        if ',' in recipient_email:
            recipients = [recipient.strip() for recipient in recipient_email.split(',')]
        else:
            recipients = [recipient_email]
        
        if not sender_email or not email_password:
            print("âŒ é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶å‘é€")
            return False
        
        # æ ¹æ®SMTPæœåŠ¡å™¨ç±»å‹é€‰æ‹©ç«¯å£å’ŒSSL
        if "163.com" in smtp_server:
            smtp_port = 465
            use_ssl = True
        elif "gmail.com" in smtp_server:
            smtp_port = 587
            use_ssl = False
        else:
            smtp_port = 587
            use_ssl = False
        
        # åˆ›å»ºé‚®ä»¶å¯¹è±¡
        msg = MIMEMultipart('alternative')
        msg['Subject'] = subject
        msg['From'] = sender_email
        msg['To'] = ', '.join(recipients)
        
        # æ·»åŠ æ–‡æœ¬ç‰ˆæœ¬
        text_part = MIMEText(content, 'plain', 'utf-8')
        msg.attach(text_part)
        
        # å¦‚æœæœ‰HTMLç‰ˆæœ¬ï¼Œæ·»åŠ HTMLç‰ˆæœ¬
        if html_content:
            html_part = MIMEText(html_content, 'html', 'utf-8')
            msg.attach(html_part)
        
        # é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼‰
        for attempt in range(3):
            try:
                if use_ssl:
                    server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=30)
                    server.login(sender_email, email_password)
                    server.sendmail(sender_email, recipients, msg.as_string())
                    server.quit()
                else:
                    server = smtplib.SMTP(smtp_server, smtp_port, timeout=30)
                    server.starttls()
                    server.login(sender_email, email_password)
                    server.sendmail(sender_email, recipients, msg.as_string())
                    server.quit()
                
                print(f"âœ… é‚®ä»¶å·²å‘é€åˆ°: {', '.join(recipients)}")
                return True
            except Exception as e:
                print(f"âŒ å‘é€é‚®ä»¶å¤±è´¥ (å°è¯• {attempt+1}/3): {e}")
                if attempt < 2:
                    import time
                    time.sleep(5)
        
        print("âŒ 3æ¬¡å°è¯•åä»æ— æ³•å‘é€é‚®ä»¶")
        return False
        
    except Exception as e:
        print(f"âŒ å‘é€é‚®ä»¶å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def run_comprehensive_analysis(llm_filepath, ml_filepath, output_filepath=None, send_email_flag=True):
    """
    è¿è¡Œç»¼åˆåˆ†æ
    
    å‚æ•°:
    - llm_filepath: å¤§æ¨¡å‹å»ºè®®æ–‡ä»¶è·¯å¾„
    - ml_filepath: MLé¢„æµ‹ç»“æœæ–‡ä»¶è·¯å¾„
    - output_filepath: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    """
    try:
        print("=" * 80)
        print("ğŸ¤– ç»¼åˆåˆ†æå¼€å§‹")
        print("=" * 80)
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(llm_filepath):
            print(f"âŒ å¤§æ¨¡å‹å»ºè®®æ–‡ä»¶ä¸å­˜åœ¨: {llm_filepath}")
            return None
        
        if not os.path.exists(ml_filepath):
            print(f"âŒ MLé¢„æµ‹ç»“æœæ–‡ä»¶ä¸å­˜åœ¨: {ml_filepath}")
            return None
        
        print(f"ğŸ“Š å¤§æ¨¡å‹å»ºè®®æ–‡ä»¶: {llm_filepath}")
        print(f"ğŸ“Š MLé¢„æµ‹ç»“æœæ–‡ä»¶: {ml_filepath}")
        print("")
        
        # æå–å¤§æ¨¡å‹å»ºè®®
        print("ğŸ“ æå–å¤§æ¨¡å‹ä¹°å–å»ºè®®...")
        llm_recommendations = extract_llm_recommendations(llm_filepath)
        print(f"âœ… æå–å®Œæˆ\n")
        
        # æå–MLé¢„æµ‹
        print("ğŸ“ æå–MLé¢„æµ‹ç»“æœ...")
        ml_predictions = extract_ml_predictions(ml_filepath)
        print(f"âœ… æå–å®Œæˆ\n")
        
        # ç”Ÿæˆæ—¥æœŸ
        date_str = datetime.now().strftime('%Y-%m-%d')
        
        # æ„å»ºç»¼åˆåˆ†ææç¤ºè¯
        prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æŠ•èµ„åˆ†æå¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¸‰éƒ¨åˆ†ä¿¡æ¯ï¼Œè¿›è¡Œç»¼åˆåˆ†æï¼Œç»™å‡ºå®è´¨çš„ä¹°å–å»ºè®®ã€‚

=== ä¿¡æ¯æ¥æº ===

ã€1. å¤§æ¨¡å‹çŸ­æœŸå’Œä¸­æœŸä¹°å–å»ºè®®ã€‘
{llm_recommendations}

ã€2. æœºå™¨å­¦ä¹ 20å¤©é¢„æµ‹ç»“æœã€‘
{ml_predictions}

ã€3. ç»¼åˆåˆ†æä»»åŠ¡ã€‘
è¯·åŸºäºä¸Šè¿°ä¿¡æ¯ï¼Œå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

1. **ä¸€è‡´æ€§åˆ†æ**ï¼š
   - åˆ†æå¤§æ¨¡å‹çŸ­æœŸå»ºè®®ä¸ML 20å¤©é¢„æµ‹çš„ä¸€è‡´æ€§
   - å¦‚æœä¸¤è€…éƒ½å»ºè®®ä¹°å…¥/ä¸Šæ¶¨ï¼Œæ ‡æ³¨ä¸º"å¼ºä¹°å…¥ä¿¡å·"
   - å¦‚æœä¸¤è€…å»ºè®®ç›¸åï¼Œåˆ†æå“ªä¸ªæ›´å¯ä¿¡
   - ä¼˜å…ˆæ¨èä¸¤è€…ä¸€è‡´çš„è‚¡ç¥¨

2. **ä¸ªè‚¡å»ºè®®æ’åº**ï¼š
   - æŒ‰ç…§"å¼ºä¹°å…¥ä¿¡å· > ä¸­ç­‰ä¿¡å· > è§‚æœ›"çš„ä¼˜å…ˆçº§æ’åº
   - å¯¹æ¯ä¸ªè‚¡ç¥¨ç»™å‡ºæ˜ç¡®çš„æ“ä½œå»ºè®®ï¼šå¼ºçƒˆä¹°å…¥ã€ä¹°å…¥ã€æŒæœ‰ã€å–å‡ºã€å¼ºçƒˆå–å‡º
   - ç®€è¦è¯´æ˜ç†ç”±ï¼ˆä¸è¶…è¿‡20å­—ï¼‰

3. **ç»¼åˆæ¨èæ¸…å•**ï¼š
   - æ¨èä¹°å…¥çš„è‚¡ç¥¨æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
   - æ¨èå–å‡ºçš„è‚¡ç¥¨æ¸…å•ï¼ˆå¦‚æœ‰ï¼‰
   - éœ€è¦å…³æ³¨çš„è‚¡ç¥¨æ¸…å•ï¼ˆè§‚æœ›ï¼‰

4. **é£é™©æç¤º**ï¼š
   - åˆ†æå½“å‰å¸‚åœºæ•´ä½“é£é™©
   - ç»™å‡ºä»“ä½æ§åˆ¶å»ºè®®ï¼ˆå»ºè®®ä»“ä½ç™¾åˆ†æ¯”ï¼‰
   - ç»™å‡ºæ­¢æŸä½å»ºè®®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜æ–‡å­—ï¼‰ï¼š

# ç»¼åˆä¹°å–å»ºè®®

## å¼ºçƒˆä¹°å…¥ä¿¡å·ï¼ˆ2-3åªï¼‰
1. [è‚¡ç¥¨ä»£ç ] [è‚¡ç¥¨åç§°] - åŸå› ï¼ˆ20å­—å†…ï¼‰

## ä¹°å…¥ä¿¡å·ï¼ˆ3-5åªï¼‰
1. [è‚¡ç¥¨ä»£ç ] [è‚¡ç¥¨åç§°] - åŸå› ï¼ˆ20å­—å†…ï¼‰

## æŒæœ‰/è§‚æœ›
1. [è‚¡ç¥¨ä»£ç ] [è‚¡ç¥¨åç§°] - ç†ç”±ï¼ˆ20å­—å†…ï¼‰

## å–å‡ºä¿¡å·ï¼ˆå¦‚æœ‰ï¼‰
1. [è‚¡ç¥¨ä»£ç ] [è‚¡ç¥¨åç§°] - ç†ç”±ï¼ˆ20å­—å†…ï¼‰

## é£é™©æ§åˆ¶å»ºè®®
- å½“å‰å¸‚åœºæ•´ä½“é£é™©ï¼š[é«˜/ä¸­/ä½]
- å»ºè®®ä»“ä½ç™¾åˆ†æ¯”ï¼š[X]%
- æ­¢æŸä½è®¾ç½®ï¼š[ç­–ç•¥]

---
åˆ†ææ—¥æœŸï¼š{date_str}
"""
        
        print("ğŸ¤– æäº¤å¤§æ¨¡å‹è¿›è¡Œç»¼åˆåˆ†æ...")
        print("")
        
        # è°ƒç”¨å¤§æ¨¡å‹
        response = chat_with_llm(prompt)
        
        if response:
            print("âœ… ç»¼åˆåˆ†æå®Œæˆ\n")
            print("=" * 80)
            print("ğŸ“Š ç»¼åˆä¹°å–å»ºè®®")
            print("=" * 80)
            print("")
            print(response)
            print("")
            print("=" * 80)
            
            # ä¿å­˜åˆ°æ–‡ä»¶
            if output_filepath is None:
                output_filepath = f'data/comprehensive_recommendations_{date_str}.txt'
            
            with open(output_filepath, 'w', encoding='utf-8') as f:
                f.write(f"{'=' * 80}\n")
                f.write(f"ç»¼åˆä¹°å–å»ºè®®\n")
                f.write(f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"åˆ†ææ—¥æœŸ: {date_str}\n")
                f.write(f"{'=' * 80}\n\n")
                f.write(response)
            
            print(f"âœ… ç»¼åˆå»ºè®®å·²ä¿å­˜åˆ° {output_filepath}")
            
            # å‘é€é‚®ä»¶é€šçŸ¥
            if send_email_flag:
                print("\nğŸ“§ å‡†å¤‡å‘é€é‚®ä»¶é€šçŸ¥...")
                email_subject = f"ã€ç»¼åˆåˆ†æã€‘æ¸¯è‚¡ä¹°å–å»ºè®® - {date_str}"
                email_content = response
                send_email(email_subject, email_content)
            
            return response
        else:
            print("âŒ å¤§æ¨¡å‹åˆ†æå¤±è´¥")
            return None
        
    except Exception as e:
        print(f"âŒ ç»¼åˆåˆ†æå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return None


def main():
    parser = argparse.ArgumentParser(description='ç»¼åˆåˆ†æè„šæœ¬ - æ•´åˆå¤§æ¨¡å‹å»ºè®®å’ŒMLé¢„æµ‹ç»“æœ')
    parser.add_argument('--llm-file', type=str, default=None, 
                       help='å¤§æ¨¡å‹å»ºè®®æ–‡ä»¶è·¯å¾„ (é»˜è®¤ä½¿ç”¨ä»Šå¤©çš„æ–‡ä»¶)')
    parser.add_argument('--ml-file', type=str, default=None,
                       help='MLé¢„æµ‹ç»“æœæ–‡ä»¶è·¯å¾„ (é»˜è®¤ä½¿ç”¨ä»Šå¤©çš„æ–‡ä»¶)')
    parser.add_argument('--output', type=str, default=None,
                       help='è¾“å‡ºæ–‡ä»¶è·¯å¾„ (é»˜è®¤ä¿å­˜åˆ°data/comprehensive_recommendations_YYYY-MM-DD.txt)')
    parser.add_argument('--no-email', action='store_true',
                       help='ä¸å‘é€é‚®ä»¶é€šçŸ¥')
    
    args = parser.parse_args()
    
    # ç”Ÿæˆæ—¥æœŸ
    date_str = datetime.now().strftime('%Y-%m-%d')
    
    # é»˜è®¤æ–‡ä»¶è·¯å¾„
    if args.llm_file is None:
        args.llm_file = f'data/llm_recommendations_{date_str}.txt'
    
    if args.ml_file is None:
        args.ml_file = f'data/ml_predictions_20d_{date_str}.txt'
    
    # è¿è¡Œç»¼åˆåˆ†æ
    result = run_comprehensive_analysis(args.llm_file, args.ml_file, args.output, 
                                       send_email_flag=not args.no_email)
    
    if result:
        print("\nâœ… ç»¼åˆåˆ†æå®Œæˆï¼")
        sys.exit(0)
    else:
        print("\nâŒ ç»¼åˆåˆ†æå¤±è´¥ï¼")
        sys.exit(1)


if __name__ == "__main__":
    main()