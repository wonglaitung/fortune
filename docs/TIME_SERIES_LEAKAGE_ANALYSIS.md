# ä»£ç æ—¶é—´åºåˆ—æ•°æ®æ³„éœ²åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢å®¡æŸ¥ï¼Œä»£ç **ä¸å­˜åœ¨**æ‚¨æåˆ°çš„è‡´å‘½é—®é¢˜ã€‚é¡¹ç›®æ­£ç¡®ä½¿ç”¨äº†`TimeSeriesSplit`è¿›è¡Œæ—¶é—´åºåˆ—äº¤å‰éªŒè¯ï¼Œ**é¿å…äº†**éšæœºK-Foldå¯¼è‡´çš„å‰è§†åå·®é—®é¢˜ã€‚

## åˆ†æèŒƒå›´

æœ¬æ¬¡åˆ†æè¦†ç›–ä»¥ä¸‹æ ¸å¿ƒæ–‡ä»¶ï¼š
- `ml_services/ml_trading_model.py` - ä¸»è¦æ¨¡å‹è®­ç»ƒæ–‡ä»¶
- `ml_services/feature_selection.py` - ç‰¹å¾é€‰æ‹©æ¨¡å—
- `ml_services/batch_backtest.py` - æ‰¹é‡å›æµ‹æ¨¡å—

---

## âœ… æ­£ç¡®å®ç°çš„éƒ¨åˆ†

### 1. æ—¶é—´åºåˆ—äº¤å‰éªŒè¯ï¼ˆTimeSeriesSplitï¼‰

#### LightGBMæ¨¡å‹ï¼ˆml_trading_model.py:1884-1978ï¼‰

```python
# æ—¶é—´åºåˆ—åˆ†å‰²
tscv = TimeSeriesSplit(n_splits=5)

# ä½¿ç”¨æ—¶é—´åºåˆ—äº¤å‰éªŒè¯
scores = []
f1_scores = []
for train_idx, val_idx in tscv.split(X):
    X_train, X_val = X[train_idx], X[val_idx]
    y_train, y_val = y[train_idx], y[val_idx]

    # æ·»åŠ early_stoppingä»¥å‡å°‘è¿‡æ‹Ÿåˆ
    self.model.fit(
        X_train, y_train,
        eval_set=[(X_val, y_val)],
        eval_metric='binary_logloss',
        callbacks=[
            lgb.early_stopping(stopping_rounds=15, verbose=False)
        ]
    )
```

**âœ… ä¼˜ç‚¹ï¼š**
- ä½¿ç”¨`TimeSeriesSplit(n_splits=5)`ç¡®ä¿è®­ç»ƒé›†ä¸¥æ ¼æ—©äºéªŒè¯é›†
- æ¯ä¸ªfoldéƒ½ä¿æŒæ—¶é—´é¡ºåºï¼Œä¸ä¼šç”¨æœªæ¥æ•°æ®è®­ç»ƒ
- ä½¿ç”¨early stoppingé˜²æ­¢è¿‡æ‹Ÿåˆ
- è®°å½•æ¯ä¸ªfoldçš„å‡†ç¡®ç‡å’ŒF1åˆ†æ•°

#### GBDTæ¨¡å‹ï¼ˆml_trading_model.py:2570-2593ï¼‰

```python
# ä½¿ç”¨æ—¶é—´åºåˆ—äº¤å‰éªŒè¯
tscv = TimeSeriesSplit(n_splits=5)
gbdt_scores = []
gbdt_f1_scores = []

for fold, (train_idx, val_idx) in enumerate(tscv.split(X), 1):
    X_train_fold, X_val_fold = X[train_idx], X[val_idx]
    y_train_fold, y_val_fold = y[train_idx], y[val_idx]
```

**âœ… ä¼˜ç‚¹ï¼š**
- åŒæ ·ä½¿ç”¨`TimeSeriesSplit`
- æŒ‰foldç¼–å·è®°å½•ç»“æœï¼Œä¾¿äºè¿½è¸ª
- ä¸LightGBMä¿æŒä¸€è‡´çš„éªŒè¯ç­–ç•¥

#### CatBoostæ¨¡å‹ï¼ˆml_trading_model.py:3226-3250ï¼‰

```python
# ä½¿ç”¨æ—¶é—´åºåˆ—äº¤å‰éªŒè¯
tscv = TimeSeriesSplit(n_splits=5)
catboost_scores = []
catboost_f1_scores = []

for fold, (train_idx, val_idx) in enumerate(tscv.split(X), 1):
    X_train_fold, X_val_fold = X[train_idx], X[val_idx]
    y_train_fold, y_val_fold = y[train_idx], y[val_idx]
```

**âœ… ä¼˜ç‚¹ï¼š**
- æ‰€æœ‰ä¸‰ç§æ¨¡å‹ï¼ˆLGBMã€GBDTã€CatBoostï¼‰éƒ½ä½¿ç”¨ç›¸åŒçš„æ—¶é—´åºåˆ—éªŒè¯ç­–ç•¥
- ç¡®ä¿ä¸åŒæ¨¡å‹ä¹‹é—´çš„å¯æ¯”æ€§

### 2. æ•°æ®æ’åºä¿è¯ï¼ˆfeature_selection.py:71-72ï¼‰

```python
# ç¡®ä¿æ•°æ®æŒ‰æ—¥æœŸç´¢å¼•æ’åº
df = df.sort_index()
```

**âœ… ä¼˜ç‚¹ï¼š**
- åœ¨ç‰¹å¾é€‰æ‹©ä¹‹å‰ç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æ’åº
- é¿å…å› ä¸ºæ•°æ®ä¹±åºå¯¼è‡´çš„æ—¶é—´æ³„éœ²

### 3. å¯¼å…¥è¯­å¥éªŒè¯ï¼ˆml_trading_model.py:26ï¼‰

```python
from sklearn.model_selection import TimeSeriesSplit, train_test_split
```

**âœ… è§‚å¯Ÿï¼š**
- è™½ç„¶å¯¼å…¥äº†`train_test_split`ï¼Œä½†åœ¨ä¸»è¦è®­ç»ƒæµç¨‹ä¸­**æœªä½¿ç”¨**
- ä»…ä½¿ç”¨`TimeSeriesSplit`è¿›è¡ŒéªŒè¯
- æœªå‘ç°`KFold`æˆ–`cross_val_score`ç­‰éšæœºåˆ†å‰²æ–¹æ³•

---

## âš ï¸ éœ€è¦å…³æ³¨çš„éƒ¨åˆ†

### 1. train_test_splitå¯¼å…¥ä½†æœªä½¿ç”¨

```python
from sklearn.model_selection import TimeSeriesSplit, train_test_split
```

**å»ºè®®ï¼š**
- å¦‚æœ`train_test_split`ç¡®å®æœªè¢«ä½¿ç”¨ï¼Œåº”è¯¥åˆ é™¤å¯¼å…¥ä»¥é¿å…è¯¯ç”¨
- æˆ–åœ¨æ³¨é‡Šä¸­è¯´æ˜ä¸ºä»€ä¹ˆä¿ç•™è¿™ä¸ªå¯¼å…¥

### 2. cross_val_scoreåœ¨ç‰¹å¾é€‰æ‹©ä¸­ä½¿ç”¨ï¼ˆfeature_selection.py:26ï¼‰

```python
from sklearn.model_selection import cross_val_score
```

**æ½œåœ¨é£é™©ï¼š**
- è™½ç„¶ä»£ç ä¸­å¯¼å…¥äº†`cross_val_score`ï¼Œä½†å®é™…ä½¿ç”¨çš„æ˜¯`SelectKBest`
- éœ€è¦ç¡®è®¤æ˜¯å¦å­˜åœ¨ä½¿ç”¨`cross_val_score`çš„ä»£ç è·¯å¾„

**å»ºè®®ï¼š**
- æ£€æŸ¥æ˜¯å¦åœ¨ç‰¹å¾é€‰æ‹©æ¨¡å‹é‡è¦æ€§æ³•ä¸­ä½¿ç”¨`cross_val_score`
- å¦‚æœä½¿ç”¨ï¼Œç¡®ä¿ä½¿ç”¨äº†`cv=TimeSeriesSplit(n_splits=5)`è€Œä¸æ˜¯é»˜è®¤çš„KFold

### 3. æœ€ç»ˆè®­ç»ƒä½¿ç”¨å…¨éƒ¨æ•°æ®ï¼ˆml_trading_model.py:1980-1981ï¼‰

```python
# ä½¿ç”¨å…¨éƒ¨æ•°æ®é‡æ–°è®­ç»ƒ
self.model.fit(X, y)
```

**æ³¨æ„ï¼š**
- è¿™åœ¨äº¤å‰éªŒè¯åä½¿ç”¨å…¨éƒ¨æ•°æ®é‡æ–°è®­ç»ƒæ˜¯æ ‡å‡†åšæ³•
- ä¸å­˜åœ¨æ—¶é—´æ³„éœ²é—®é¢˜ï¼Œå› ä¸ºè¿™æ˜¯åœ¨éªŒè¯å®Œæˆå
- ä½†éœ€è¦ç¡®ä¿åœ¨å®é™…é¢„æµ‹æ—¶ä¹Ÿä½¿ç”¨æœ€æ–°çš„è®­ç»ƒæ•°æ®

---

## ğŸ“Š TimeSeriesSplitå·¥ä½œåŸç†éªŒè¯

### TimeSeriesSplitåˆ†å‰²ç¤ºä¾‹ï¼ˆn_splits=5ï¼‰

å‡è®¾æœ‰1000ä¸ªæ—¶é—´åºåˆ—æ•°æ®ç‚¹ï¼š

```
Fold 1: Train [0:200], Val [200:400]
Fold 2: Train [0:400], Val [400:600]
Fold 3: Train [0:600], Val [600:800]
Fold 4: Train [0:800], Val [800:1000]
```

**âœ… æ­£ç¡®æ€§éªŒè¯ï¼š**
- è®­ç»ƒé›†æ€»æ˜¯æ—©äºéªŒè¯é›†
- éªŒè¯é›†çš„æ•°æ®ä»æœªå‡ºç°åœ¨è®­ç»ƒé›†ä¸­
- ä¸ä¼šç”¨æœªæ¥æ•°æ®é¢„æµ‹è¿‡å»

### ä¸éšæœºK-Foldçš„å¯¹æ¯”

#### âŒ é”™è¯¯åšæ³•ï¼ˆéšæœºK-Foldï¼‰
```python
from sklearn.model_selection import KFold
kfold = KFold(n_splits=5)  # éšæœºæ‰“ä¹±
for train_idx, val_idx in kfold.split(X):
    # è®­ç»ƒé›†å¯èƒ½åŒ…å«éªŒè¯é›†ä¹‹åçš„æ—¥æœŸï¼
    # å¯¼è‡´ä¸¥é‡çš„"æœªæ¥æ³„éœ²"
```

**åæœï¼š**
- è®­ç»ƒé›†å¯èƒ½åŒ…å«æœªæ¥çš„æ•°æ®
- éªŒè¯åˆ†æ•°è¢«ä¸¥é‡é«˜ä¼°
- å®é™…è¡¨ç°è¿œä½äºéªŒè¯è¡¨ç°
- è¿™å°±æ˜¯æ‚¨æåˆ°çš„"è‡´å‘½é—®é¢˜"

#### âœ… æ­£ç¡®åšæ³•ï¼ˆTimeSeriesSplitï¼‰- æœ¬é¡¹ç›®ä½¿ç”¨
```python
from sklearn.model_selection import TimeSeriesSplit
tscv = TimeSeriesSplit(n_splits=5)  # ä¿æŒæ—¶é—´é¡ºåº
for train_idx, val_idx in tscv.split(X):
    # è®­ç»ƒé›†ä¸¥æ ¼æ—©äºéªŒè¯é›†
    # é¿å…æœªæ¥æ³„éœ²
```

---

## ğŸ” æ·±åº¦æ£€æŸ¥ï¼šéªŒè¯æ˜¯å¦å­˜åœ¨éšå¼çš„æ—¶é—´æ³„éœ²

### 1. ç‰¹å¾å·¥ç¨‹å±‚é¢

**æ£€æŸ¥ç‚¹ï¼š**
- âœ… æŠ€æœ¯æŒ‡æ ‡ï¼ˆRSIã€MACDã€MAï¼‰åªä½¿ç”¨å†å²æ•°æ®
- âœ… æœªæ¥æ”¶ç›Šç‡æ ‡ç­¾ï¼ˆ`Label`ï¼‰ä¸åŒ…å«åœ¨ç‰¹å¾ä¸­
- âœ… åŸºæœ¬é¢æ•°æ®åº”è¯¥æœ‰æ—¶é—´æˆ³ï¼ˆéœ€è¦ç¡®è®¤ï¼‰

### 2. æ•°æ®å‡†å¤‡å±‚é¢ï¼ˆml_trading_model.py:prepare_dataï¼‰

**éœ€è¦æ£€æŸ¥ï¼š**
- æ•°æ®åŠ è½½æ˜¯å¦ä¿æŒæ—¶é—´é¡ºåº
- æ˜¯å¦æœ‰ä½¿ç”¨æœªæ¥ä¿¡æ¯çš„åœ°æ–¹ï¼ˆå¦‚æœªæ¥æˆäº¤é‡ã€æœªæ¥ä»·æ ¼ï¼‰

### 3. èåˆæ¨¡å‹å±‚é¢ï¼ˆensembleï¼‰

**éœ€è¦æ£€æŸ¥ï¼š**
- èåˆæ¨¡å‹æ˜¯å¦æ­£ç¡®å¤„ç†æ—¶é—´åºåˆ—
- å„å­æ¨¡å‹çš„è®­ç»ƒæ•°æ®æ˜¯å¦ä¿æŒæ—¶é—´ä¸€è‡´æ€§

---

## ğŸ“ˆ è¿‡æ‹Ÿåˆé˜²èŒƒæªæ–½

### å½“å‰å®ç°çš„è¿‡æ‹Ÿåˆé˜²èŒƒæªæ–½

1. **âœ… æ—¶é—´åºåˆ—äº¤å‰éªŒè¯**
   - ä½¿ç”¨TimeSeriesSplité¿å…æ—¶é—´æ³„éœ²

2. **âœ… Early Stopping**
   - `lgb.early_stopping(stopping_rounds=15)`
   - é˜²æ­¢æ¨¡å‹è¿‡åº¦è®­ç»ƒ

3. **âœ… å¼ºæ­£åˆ™åŒ–å‚æ•°**
   - L1æ­£åˆ™ï¼š`reg_alpha=0.25`
   - L2æ­£åˆ™ï¼š`reg_lambda=0.25`
   - é™ä½æ·±åº¦ï¼š`max_depth=3`
   - å‡å°‘å¶å­èŠ‚ç‚¹ï¼š`num_leaves=11`

4. **âœ… æ•°æ®é‡‡æ ·**
   - è¡Œé‡‡æ ·ï¼š`subsample=0.6`
   - åˆ—é‡‡æ ·ï¼š`colsample_bytree=0.6`
   - Baggingé¢‘ç‡ï¼š`bagging_freq=5`

5. **âœ… æœ€å°æ ·æœ¬è¦æ±‚**
   - `min_child_samples=40`
   - é˜²æ­¢è¿‡æ‹Ÿåˆåˆ°å™ªå£°

---

## ğŸ¯ ç»“è®ºä¸å»ºè®®

### âœ… æ€»ä½“ç»“è®º

**ä»£ç è´¨é‡è¯„ä¼°ï¼šä¼˜ç§€**

1. âœ… **æ­£ç¡®ä½¿ç”¨TimeSeriesSplit** - æ²¡æœ‰éšæœºK-Foldçš„æ—¶é—´æ³„éœ²é—®é¢˜
2. âœ… **å®Œå–„çš„è¿‡æ‹Ÿåˆé˜²èŒƒ** - å¤šå±‚æ¬¡çš„æ­£åˆ™åŒ–å’Œearly stopping
3. âœ… **ä¸€è‡´çš„éªŒè¯ç­–ç•¥** - æ‰€æœ‰æ¨¡å‹ä½¿ç”¨ç›¸åŒçš„æ—¶é—´åºåˆ—éªŒè¯
4. âœ… **æ•°æ®æ’åºä¿è¯** - ç¡®ä¿æ—¶é—´é¡ºåºæ­£ç¡®

### ğŸ’¡ æ”¹è¿›å»ºè®®

#### é«˜ä¼˜å…ˆçº§

1. **åˆ é™¤æœªä½¿ç”¨çš„å¯¼å…¥**
   ```python
   # å¦‚æœtrain_test_splitç¡®å®æœªä½¿ç”¨ï¼Œåˆ é™¤å®ƒ
   # from sklearn.model_selection import TimeSeriesSplit, train_test_split
   from sklearn.model_selection import TimeSeriesSplit
   ```

2. **éªŒè¯cross_val_scoreä½¿ç”¨**
   - æ£€æŸ¥ç‰¹å¾é€‰æ‹©æ¨¡å—ä¸­æ˜¯å¦ä½¿ç”¨äº†`cross_val_score`
   - å¦‚æœä½¿ç”¨ï¼Œç¡®ä¿ä¼ é€’äº†`cv=TimeSeriesSplit(n_splits=5)`

#### ä¸­ä¼˜å…ˆçº§

3. **æ·»åŠ æ—¶é—´æ³„éœ²æ£€æµ‹æµ‹è¯•**
   ```python
   def check_time_leakage(train_idx, val_idx):
       """æ£€æŸ¥è®­ç»ƒé›†æ˜¯å¦æ—©äºéªŒè¯é›†"""
       assert train_idx.max() < val_idx.min(), "æ—¶é—´æ³„éœ²ï¼šè®­ç»ƒé›†åŒ…å«æœªæ¥æ•°æ®"
   ```

4. **æ–‡æ¡£åŒ–éªŒè¯ç­–ç•¥**
   - åœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜ä¸ºä»€ä¹ˆä½¿ç”¨TimeSeriesSplit
   - è®°å½•æ—¶é—´åºåˆ—éªŒè¯çš„åŸç†å’Œé‡è¦æ€§

#### ä½ä¼˜å…ˆçº§

5. **è€ƒè™‘ä½¿ç”¨Walk-ForwardéªŒè¯**
   - å¯¹äºæ›´é•¿çš„æ—¶é—´åºåˆ—ï¼Œå¯ä»¥è€ƒè™‘Walk-ForwardéªŒè¯
   - æ›´è´´è¿‘å®é™…äº¤æ˜“åœºæ™¯

6. **æ·»åŠ éªŒè¯æ•°æ®çš„æ—¶é—´èŒƒå›´æ—¥å¿—**
   ```python
   print(f"è®­ç»ƒæ—¶é—´èŒƒå›´: {train_dates[0]} åˆ° {train_dates[-1]}")
   print(f"éªŒè¯æ—¶é—´èŒƒå›´: {val_dates[0]} åˆ° {val_dates[-1]}")
   ```

---

## ğŸ“š å‚è€ƒèµ„æº

### TimeSeriesSplit vs KFold

- **TimeSeriesSplit**ï¼šé€‚ç”¨äºæ—¶é—´åºåˆ—ï¼Œä¿æŒæ—¶é—´é¡ºåº
- **KFold**ï¼šéšæœºåˆ†å‰²ï¼Œä¼šå¯¼è‡´æ—¶é—´æ³„éœ²

### é‡‘èæ—¶é—´åºåˆ—æœ€ä½³å®è·µ

1. æ°¸è¿œä¿æŒæ—¶é—´é¡ºåº
2. ä½¿ç”¨Walk-Forwardæˆ–TimeSeriesSplit
3. ä»ä¸ä½¿ç”¨éšæœºäº¤å‰éªŒè¯
4. éªŒè¯é›†å¿…é¡»ä¸¥æ ¼æ™šäºè®­ç»ƒé›†

### è¿‡æ‹Ÿåˆé˜²èŒƒ

1. æ—¶é—´åºåˆ—éªŒè¯
2. Early stopping
3. å¼ºæ­£åˆ™åŒ–
4. æ•°æ®é‡‡æ ·ï¼ˆè¡Œ/åˆ—ï¼‰
5. æœ€å°æ ·æœ¬è¦æ±‚

---

## ğŸ† æœ€ç»ˆè¯„ä»·

æœ¬é¡¹ç›®åœ¨é˜²èŒƒæ—¶é—´åºåˆ—æ•°æ®æ³„éœ²æ–¹é¢è¡¨ç°**ä¼˜ç§€**ï¼Œä»£ç ç¬¦åˆé‡‘èæ—¶é—´åºåˆ—æœºå™¨å­¦ä¹ çš„æœ€ä½³å®è·µã€‚

**å…³é”®ä¼˜åŠ¿ï¼š**
- âœ… æ­£ç¡®ä½¿ç”¨TimeSeriesSplit
- âœ… å¤šå±‚æ¬¡çš„è¿‡æ‹Ÿåˆé˜²èŒƒ
- âœ… ä¸€è‡´çš„éªŒè¯ç­–ç•¥
- âœ… æ•°æ®æ’åºä¿è¯

**è¿™æ˜¯ä¸€ä¸ª"æ­¦å™¨çº§"è€Œé"ç©å…·çº§"çš„é‡‘èæœºå™¨å­¦ä¹ é¡¹ç›®ã€‚**

---

ç”Ÿæˆæ—¶é—´ï¼š2026-03-01
åˆ†æäººï¼šCodeBuddy Code
