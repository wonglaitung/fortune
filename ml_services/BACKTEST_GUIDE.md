# 回测评估功能使用指南

## ⚠️ CatBoost 1天模型过拟合警告（2026-02-20）

> **🔴 CatBoost 1天模型存在严重过拟合风险，不推荐使用**
>
> **问题描述**：
> - CatBoost 1天模型准确率65.62%（±5.97%）
> - 标准偏差±5.97%过高，表明模型在不同fold上表现不稳定
> - 准确率远高于其他模型的1天准确率（~51%）
> - 准确率甚至高于CatBoost 5天（63.01%）和20天（61.09%），违反一般规律
>
> **根本原因**：
> - 样本量差异：1天模型训练样本最多，更容易过拟合
> - CatBoost自动分类特征处理可能在短期预测中过度优化
> - 短期波动噪声被模型过度学习
>
> **验证结果**：
> - ✅ 代码审查通过（没有数据泄漏）
> - ✅ 时间序列交叉验证正确
> - ✅ 日期索引保留
> - ❌ 存在严重过拟合（准确率高 + 标准偏差高）
>
> **建议措施**：
> - **不推荐使用** CatBoost 1天模型的预测结果和回测
> - **推荐使用** CatBoost 20天模型和融合模型作为主要预测来源
> - **谨慎使用** CatBoost 5天模型（需要更多验证）
>
> **模型可信度评估**：
> - CatBoost 20天：⭐⭐⭐⭐⭐（高可信度）
> - 融合模型（加权平均）：⭐⭐⭐⭐⭐（高可信度）
> - CatBoost 5天：⭐⭐⭐（中等可信度）
> - **CatBoost 1天：⭐（低可信度，不推荐）**

## 功能概述

回测评估模块 (`backtest_evaluator.py`) 用于验证机器学习模型在真实交易环境中的盈利能力，评估模型的实际可用性。

**核心功能**：
- 验证模型的实际盈利能力
- 评估风险调整后收益（夏普比率、索提诺比率）
- 计算最大回撤和胜率
- 生成可视化报告（4个子图）
- 支持三分类预测（上涨/观望/下跌）
- 提供置信度和一致性评估
- 支持单一模型和融合模型回测

## 核心功能

### 1. 关键指标计算

#### 收益指标
- **总收益率**: 回测期间的总收益
- **年化收益率**: 按年化计算的收益率
- **最终资金**: 回测结束时的资金总额

#### 风险指标
- **夏普比率**: 风险调整后收益（>1.0优秀，>0.5良好）
- **索提诺比率**: 下行风险调整后收益（只考虑亏损）
- **最大回撤**: 历史最大亏损幅度（<20%优秀，<30%良好）

#### 交易统计
- **胜率**: 盈利交易占比
- **信息比率**: 相对基准的超额收益质量
- **总交易次数**: 完整的买卖循环数

### 2. 回测逻辑

**交易策略**:
- 当模型预测概率 > 置信度阈值（默认0.55）时，全仓买入
- 当模型预测概率 ≤ 置信度阈值时，清仓卖出
- 考虑交易成本：佣金0.1% + 滑点0.1%
- **三分类预测**（2026-02-21 新增）：
  - 高置信度上涨（fused_probability > 0.60）：建议买入
  - 中等置信度观望（0.50 < fused_probability ≤ 0.60）：建议持有
  - 预测下跌（fused_probability ≤ 0.50）：建议卖出

**基准策略**: 买入持有（Buy & Hold）

### 3. 可视化输出

生成4个子图的回测报告：
1. **组合价值对比**: 模型策略 vs 基准策略
2. **收益率分布**: 日收益率直方图
3. **回撤曲线**: 历史回撤走势
4. **关键指标对比**: 重要指标的柱状图对比

**JSON文件包含**：
- 基本指标：总收益率、年化收益率、最终资金
- 风险指标：夏普比率、索提诺比率、最大回撤
- 交易统计：胜率、总交易次数、盈利/亏损交易数
- **三分类预测**（2026-02-21 新增）：融合预测、融合概率、置信度、一致性
- 股票信息：股票代码、回测策略、选择方法

## 使用方法

### 批量回测（推荐）

**批量回测功能**（2026-02-22）支持对自选股列表中的所有股票进行批量回测，全面评估模型在不同股票上的表现。这是**唯一推荐的回测方式**，可以提供更全面的模型性能评估。

#### 批量回测单一模型

```bash
# 批量回测 LightGBM 20天模型
python3 ml_services/batch_backtest.py --model-type lgbm --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 批量回测 GBDT 20天模型
python3 ml_services/batch_backtest.py --model-type gbdt --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 批量回测 CatBoost 20天模型
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.55
```

#### 批量回测融合模型

```bash
# 批量回测融合模型（加权平均 - 推荐）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method weighted --use-feature-selection --confidence-threshold 0.55

# 批量回测融合模型（简单平均）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method average --use-feature-selection --confidence-threshold 0.55

# 批量回测融合模型（投票机制）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method voting --use-feature-selection --confidence-threshold 0.55
```

#### 不同置信度阈值测试

```bash
# 置信度0.55（推荐，平衡点）
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 置信度0.60（保守型投资者）
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.60
```

### 方法2: 直接使用回测评估器

```python
from ml_services.backtest_evaluator import BacktestEvaluator

# 创建评估器
evaluator = BacktestEvaluator(initial_capital=100000)

# 运行回测
results = evaluator.backtest_model(
    model=your_trained_model,
    test_data=test_features,
    test_labels=test_labels,
    test_prices=test_prices,
    confidence_threshold=0.55
)

# 绘制图表
evaluator.plot_backtest_results(results, save_path='output/backtest_results.png')
```

### 方法3: 测试模式（使用模拟数据）

```bash
cd ml_services
python3 backtest_evaluator.py
```

### ⚠️ 单只股票回测功能已删除（2026-02-22）

**重要提示**：单只股票回测功能已被删除，现在只支持批量回测功能。

**删除原因**：
- 单只股票回测结果具有随机性，无法全面评估模型性能
- 批量回测可以对所有28只股票逐一回测，提供更可靠的评估
- 批量回测生成的汇总报告包含平均表现和排名，更便于分析和决策

**替代方案**：使用批量回测功能（`batch_backtest.py`），它可以对所有股票逐一进行回测，并提供详细的汇总报告。

## 输出文件

批量回测完成后会生成以下文件：

1. **汇总报告**：`output/batch_backtest_summary_{model_type}_{horizon}d_{timestamp}.txt`
   - 包含所有股票的回测结果汇总
   - 平均表现统计
   - 优秀/良好/一般/较差股票数量
   - 股票排名（按夏普比率、总收益率等）

2. **详细数据**：`output/batch_backtest_{model_type}_{horizon}d_{timestamp}.json`
   - 包含所有股票的详细回测数据
   - 每只股票的关键指标、交易记录等

JSON文件包含所有关键指标：
```json
{
  "stock_code": "0700.HK",
  "stock_name": "腾讯控股",
  "total_return": 0.1523,
  "annual_return": 0.1523,
  "final_capital": 115230.0,
  "sharpe_ratio": 1.23,
  "sortino_ratio": 1.56,
  "max_drawdown": -0.1845,
  "win_rate": 0.58,
  "total_trades": 24,
  "winning_trades": 14,
  "losing_trades": 10,
  "information_ratio": 0.45,
  "benchmark_return": 0.0856,
  "benchmark_annual_return": 0.0856,
  "benchmark_sharpe": 0.52,
  "benchmark_max_drawdown": -0.2534
}
```

## 融合模型回测特点

### 优势

1. **降低方差**：三模型融合可降低预测方差15-20%
2. **提升稳定性**：避免单一模型的过拟合风险
3. **自动权重**：加权平均基于准确率自动分配权重
4. **置信度评估**：提供模型一致性评估（100%/67%/33%）
5. **三分类预测**：支持上涨/观望/下跌三分类，更贴近实际投资决策
6. **置信度和一致性独立评估**：
   - 置信度：反映预测的可信程度（基于融合概率）
   - 一致性：反映多模型的意见统一程度（基于模型预测一致性）
7. **CatBoost 模型优势**：
   - 自动处理分类特征，无需手动编码
   - 更好的默认参数，减少调参工作量
   - 更快的训练速度，支持 GPU 加速
   - 更好的泛化能力，减少过拟合
   - **稳定性显著提升**（±1.50% vs LightGBM ±4.38%，提升 65.8%）

### 三分类预测标准（2026-02-21 新增）

- **高置信度上涨**：fused_probability > 0.60 → 融合预测 = 1（上涨）
- **中等置信度观望**：0.50 < fused_probability ≤ 0.60 → 融合预测 = 0.5（观望）
- **预测下跌**：fused_probability ≤ 0.50 → 融合预测 = 0（下跌）

### 置信度评估

- **高置信度**：fused_probability > 0.60
- **中等置信度**：0.50 < fused_probability ≤ 0.60
- **低置信度**：fused_probability ≤ 0.50

### 一致性评估

- **100% 一致**：三个模型预测相同（1或0）
- **67% 一致**：三个模型中两个预测相同（如 1,1,0）
- **50% 一致**：两个模型预测不同（如 1,0）
- **33% 一致**：三个模型预测都不同

### 当前性能（2026-02-21）

**单一模型性能**（来自 `data/model_accuracy.json`）：
- **CatBoost 20天**：61.09%（±1.50%）⭐ **当前最佳（稳定可靠）**
- **CatBoost 5天**：63.01%（±4.45%）⚠️ 谨慎使用（需要更多验证）
- **CatBoost 1天**：65.62%（±5.97%）❌ **不推荐使用**（存在严重过拟合风险）
- **LightGBM 20天**：58.87%（±4.38%）
- **GBDT 20天**：58.84%（±4.34%）
- **LightGBM 1天**：51.20%（±0.97%）
- **GBDT 1天**：51.59%（±1.61%）
- **LightGBM 5天**：55.20%（±2.20%）
- **GBDT 5天**：55.19%（±2.54%）

**CatBoost 模型优势**：
- 自动处理分类特征，无需手动编码
- 更好的默认参数，减少调参工作量
- 更快的训练速度，支持 GPU 加速
- 更好的泛化能力，减少过拟合
- **稳定性显著提升**（±1.50% vs LightGBM ±4.38%，提升 65.8%）

**⚠️ CatBoost 1天模型过拟合风险**：
- 准确率65.62%（±5.97%），标准偏差过高
- 存在严重过拟合风险，不推荐使用
- 推荐使用 CatBoost 20天模型和融合模型作为主要预测来源

**融合模型预期性能**：
- 加权平均融合：准确率 ~61-62%（±1.5-2.0%）
- 预期夏普比率：1.8-2.3（非常优秀）
- 预期最大回撤：-15% 至 -18%（良好）
- 评级：⭐⭐⭐⭐⭐ 优秀

### 回测结果示例（置信度阈值 0.55）

**注意**：以下为历史单只股票回测结果（已删除该功能，仅保留批量回测）。批量回测结果见"批量回测"章节。

**LightGBM 20天模型（1398.HK工商银行）**：
- 总收益率：11.73%
- 年化收益率：6.47%
- 夏普比率：0.36（一般）
- 最大回撤：-9.69%（良好）
- 胜率：28.30%
- 总交易次数：53次
- 评级：⭐⭐⭐ 一般

**GBDT 20天模型（1288.HK工商银行）**：
- 总收益率：73.99%
- 年化收益率：40.80%
- 夏普比率：1.48（优秀）
- 最大回撤：-9.69%（良好）
- 胜率：28.30%
- 总交易次数：53次
- 评级：⭐⭐⭐⭐⭐ 优秀，值得实盘交易

**CatBoost 20天模型（1288.HK工商银行）**：
- 总收益率：184.00%
- 年化收益率：100.80%
- 夏普比率：1.62（非常优秀）
- 最大回撤：-23.32%（良好）
- 胜率：28.57%
- 总交易次数：42次
- 评级：⭐⭐⭐⭐ 良好，可以考虑实盘

**融合模型（加权平均）（1211.HK比亚迪股份）**：
- 总收益率：543.17%
- 年化收益率：299.51%
- 夏普比率：2.30（非常优秀）
- 最大回撤：-18.52%（良好）
- 胜率：40.38%
- 总交易次数：52次
- 评级：⭐⭐⭐⭐⭐ 优秀，值得实盘交易
- **优势**：降低预测方差15-20%，提升模型稳定性，支持三分类预测
- **建议**：优先使用融合模型进行回测

## 评价标准

### 综合评级

| 夏普比率 | 最大回撤 | 评级 | 建议 |
|---------|---------|-----|------|
| > 1.0 | < -20% | ⭐⭐⭐⭐⭐ | 优秀：值得实盘交易 |
| > 0.5 | < -30% | ⭐⭐⭐⭐ | 良好：可以考虑实盘 |
| > 0.0 | < -40% | ⭐⭐⭐ | 一般：需要优化 |
| ≤ 0.0 | ≥ -40% | ⭐⭐ | 较差：需要改进 |

### 关键指标解读

**夏普比率 (Sharpe Ratio)**:
- > 2.0: 非常优秀
- 1.0-2.0: 优秀
- 0.5-1.0: 良好
- 0-0.5: 一般
- < 0: 较差

**最大回撤 (Max Drawdown)**:
- < -10%: 非常保守
- -10% to -20%: 优秀
- -20% to -30%: 良好
- -30% to -40%: 一般
- > -40%: 较差

**胜率 (Win Rate)**:
- > 60%: 优秀
- 50%-60%: 良好
- 40%-50%: 一般
- < 40%: 较差

## 参数说明

### BacktestEvaluator 初始化参数

- **initial_capital**: 初始资金（默认100000港币）

### backtest_model 参数

- **model**: 训练好的模型（必须有predict_proba方法）
- **test_data**: 测试特征数据（DataFrame）
- **test_labels**: 测试标签（Series，0=下跌，1=上涨）
- **test_prices**: 测试价格数据（Series）
- **confidence_threshold**: 置信度阈值（默认0.55）
- **commission**: 交易佣金（默认0.001 = 0.1%）
- **slippage**: 滑点（默认0.001 = 0.1%）

### 融合模型回测额外参数

- **--model-type ensemble**: 使用融合模型
- **--fusion-method average**: 简单平均（默认weighted）
- **--fusion-method weighted**: 加权平均（推荐）
- **--fusion-method voting**: 投票机制

### 特征选择优化参数

- **--skip-feature-selection**: 跳过特征选择，直接使用已有的特征文件（适用于批量训练多个模型）
  - 配合 `--use-feature-selection` 使用
  - 在 `run_comprehensive_analysis.sh` 中用于避免重复执行特征选择
  - 特征选择只需执行一次（步骤0），后续模型训练都跳过特征选择（步骤2）
  - 性能提升：减少执行时间 50-70%

## 注意事项

1. **数据要求**: 回测需要完整的历史价格数据
2. **时间序列**: 确保测试数据按时间顺序排列
3. **模型要求**:
   - 单一模型需要支持`predict_proba`方法以获取概率
   - 融合模型自动支持`predict_proba`和`predict_classes`方法
   - 融合模型支持三分类预测（上涨/观望/下跌）
4. **交易成本**: 默认设置0.2%的总成本（佣金+滑点），可根据实际情况调整
5. **样本量**: 建议至少有252个交易日（1年）的数据进行回测
6. **CatBoost 1天模型过拟合风险**: 不推荐使用 CatBoost 1天模型进行回测，建议使用 CatBoost 20天模型和融合模型
7. **三分类预测置信度阈值**：
   - 高置信度上涨：fused_probability > 0.60
   - 中等置信度观望：0.50 < fused_probability ≤ 0.60
   - 预测下跌：fused_probability ≤ 0.50
8. **批量回测优先**：推荐使用批量回测功能（`batch_backtest.py`），可以全面评估模型在不同股票上的表现

## 完整工作流程

```bash
# 1. 特征选择（只执行一次）
python3 ml_services/feature_selection.py --top-k 500 --output-dir output

# 2. 训练模型（跳过特征选择，使用步骤1的特征）
python3 ml_services/ml_trading_model.py --mode train --horizon 20 --model-type lgbm --use-feature-selection --skip-feature-selection
python3 ml_services/ml_trading_model.py --mode train --horizon 20 --model-type gbdt --use-feature-selection --skip-feature-selection
python3 ml_services/ml_trading_model.py --mode train --horizon 20 --model-type catboost --use-feature-selection --skip-feature-selection

# 3. 评估模型准确率（自动保存到 data/model_accuracy.json）
python3 ml_services/ml_trading_model.py --mode evaluate --horizon 20 --model-type lgbm --use-feature-selection --skip-feature-selection
python3 ml_services/ml_trading_model.py --mode evaluate --horizon 20 --model-type gbdt --use-feature-selection --skip-feature-selection
python3 ml_services/ml_trading_model.py --mode evaluate --horizon 20 --model-type catboost --use-feature-selection --skip-feature-selection

# 4. 批量回测所有股票（推荐）
python3 ml_services/batch_backtest.py --model-type lgbm --horizon 20 --use-feature-selection --skip-feature-selection --confidence-threshold 0.55
python3 ml_services/batch_backtest.py --model-type gbdt --horizon 20 --use-feature-selection --skip-feature-selection --confidence-threshold 0.55
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --skip-feature-selection --confidence-threshold 0.55
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method weighted --use-feature-selection --skip-feature-selection --confidence-threshold 0.55

# 5. 查看回测结果
# - 汇总报告: output/batch_backtest_summary_{model_type}_{horizon}d_{timestamp}.txt
# - 详细数据: output/batch_backtest_{model_type}_{horizon}d_{timestamp}.json
```

## 实际应用建议

### 三分类预测标准（2026-02-21 新增）

融合模型支持三分类预测，更贴近实际投资决策：

- **高置信度上涨**（fused_probability > 0.60）：
  - 融合预测：上涨（1）
  - 操作建议：买入/加仓
  - 仓位建议：3-5%
  - 止损设置：-8% 至 -10%
  - 适合：短线交易

- **中等置信度观望**（0.50 < fused_probability ≤ 0.60）：
  - 融合预测：观望（0.5）
  - 操作建议：持有/观望
  - 仓位建议：维持现有仓位
  - 避免过度交易
  - 适合：等待更强信号

- **预测下跌**（fused_probability ≤ 0.50）：
  - 融合预测：下跌（0）
  - 操作建议：卖出/减仓
  - 仓位建议：清仓或轻仓
  - 避免接飞刀
  - 适合：风险控制

### 置信度和一致性综合判断

**高置信度 + 高一致性（100%）**：
- 强烈买入/卖出信号
- 可增加仓位至5-8%
- 严格设置止损

**中等置信度 + 中等一致性（67%）**：
- 适度买入/卖出信号
- 仓位控制在3-5%
- 设置止损和止盈

**低置信度 + 低一致性（33%或<50%）**：
- 不建议交易
- 观望为主
- 等待更强的信号

## 批量回测功能（2026-02-22）

批量回测功能 (`batch_backtest.py`) 支持对自选股列表中的所有股票进行批量回测，全面评估模型在不同股票上的表现。这是**唯一推荐的回测方式**。

### 功能特点

1. **批量处理**：一次性对28只自选股进行回测
2. **多模型支持**：支持 LightGBM、GBDT、CatBoost、融合模型
3. **股票名称显示**：回测结果同时显示股票代码和股票名称
4. **结果汇总**：自动生成汇总报告，包括平均表现和排名
5. **置信度阈值支持**：支持不同置信度阈值（0.55、0.60等）
6. **JSON数据保存**：每只股票的回测结果保存为独立JSON文件

### 使用方法

#### 批量回测单一模型

```bash
# 批量回测 LightGBM 20天模型
python3 ml_services/batch_backtest.py --model-type lgbm --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 批量回测 GBDT 20天模型
python3 ml_services/batch_backtest.py --model-type gbdt --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 批量回测 CatBoost 20天模型
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.55
```

#### 批量回测融合模型

```bash
# 批量回测融合模型（加权平均 - 推荐）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method weighted --use-feature-selection --confidence-threshold 0.55

# 批量回测融合模型（简单平均）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method average --use-feature-selection --confidence-threshold 0.55

# 批量回测融合模型（投票机制）
python3 ml_services/batch_backtest.py --model-type ensemble --horizon 20 --fusion-method voting --use-feature-selection --confidence-threshold 0.55
```

#### 不同置信度阈值测试

```bash
# 置信度0.55（推荐，平衡点）
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.55

# 置信度0.60（保守型投资者）
python3 ml_services/batch_backtest.py --model-type catboost --horizon 20 --use-feature-selection --confidence-threshold 0.60
```

### 输出文件

批量回测完成后会生成以下文件：

1. **汇总报告**：`output/batch_backtest_summary_{model_type}_{horizon}d_{timestamp}.txt`
   - 包含所有股票的回测结果汇总
   - 平均表现统计
   - 优秀/良好/一般/较差股票数量
   - 股票排名（按夏普比率、总收益率等）

2. **详细数据**：`output/batch_backtest_{model_type}_{horizon}d_{timestamp}.json`
   - 包含所有股票的详细回测数据
   - 每只股票的关键指标、交易记录等

### 批量回测结果（置信度0.55，28只股票，2026-02-22）

| 模型 | 平均总收益率 | 平均夏普比率 | 平均最大回撤 | 平均胜率 | 优秀股票（收益率>50%） | 建议 |
|------|------------|------------|------------|---------|---------------------|------|
| **CatBoost 20天** | **238.76%** | **1.51** | -19.08% | **32.81%** | **24只** | ⭐⭐⭐⭐⭐ 最佳 |
| 融合模型（加权平均） | 115.13% | 1.00 | -23.07% | 31.89% | 22只 | ⭐⭐⭐⭐⭐ 推荐 |
| GBDT 20天 | -1.86% | -0.06 | -37.93% | 29.88% | 4只 | ⭐⭐⭐ 一般 |
| LightGBM 20天 | -8.22% | -0.18 | -37.12% | 29.57% | 2只 | ⭐⭐ 较差 |

### 批量回测结果（置信度0.60，28只股票，2026-02-22）

| 模型 | 平均总收益率 | 平均夏普比率 | 平均最大回撤 | 平均胜率 | 优秀股票（收益率>50%） | 建议 |
|------|------------|------------|------------|---------|---------------------|------|
| **CatBoost 20天** | **206.72%** | **1.52** | -17.29% | **31.84%** | **23只** | ⭐⭐⭐⭐⭐ 最佳 |
| 融合模型（加权平均） | 75.97% | 0.86 | -23.07% | 30.97% | 15只 | ⭐⭐⭐⭐ 推荐 |
| GBDT 20天 | -13.02% | -0.31 | -37.93% | 25.11% | 1只 | ⭐⭐ 较差 |
| LightGBM 20天 | -14.96% | -0.24 | -37.12% | 26.47% | 0只 | ⭐ 较差 |

### CatBoost 批量回测详细表现（置信度0.60，28只股票）

- 最高收益率：878.98%（1347.HK 华虹半导体）
- 最低收益率：16.73%（0941.HK 中国移动）
- 收益率中位数：133.93%
- 收益率标准差：194.64%
- **优秀股票（收益率>50%）**：23只
- **一般股票（收益率20-50%）**：3只
- **表现不佳（收益率<20%）**：2只（0728.HK 中国电信 26.66%、0941.HK 中国移动 16.73%）

### 置信度阈值对比分析（2026-02-22）

**收益与胜率对比**：

| 模型 | 置信度0.55收益率 | 置信度0.60收益率 | 收益变化 | 置信度0.55胜率 | 置信度0.60胜率 | 胜率变化 |
|------|--------------|--------------|---------|-------------|-------------|---------|
| CatBoost 20天 | 238.76% | 206.72% | -32.04% ⬇️ | 32.81% | 31.84% | -0.97% ⬇️ |
| 融合模型 | 115.13% | 75.97% | -39.16% ⬇️ | 31.89% | 30.97% | -0.92% ⬇️ |
| GBDT 20天 | -1.86% | -13.02% | -11.16% ⬇️ | 29.88% | 25.11% | -4.77% ⬇️ |
| LightGBM 20天 | -8.22% | -14.96% | -6.74% ⬇️ | 29.57% | 26.47% | -3.10% ⬇️ |

**关键发现**：

1. **提高置信度阈值的影响**：
   - ❌ 所有模型的收益率都下降（CatBoost下降32.04%，融合模型下降39.16%）
   - ❌ 所有模型的胜率都下降（CatBoost下降0.97%，融合模型下降0.92%）
   - 交易频率降低（约30%），但每次交易的可靠性并未相应提升

2. **为什么提高置信度反而降低了胜率和收益率？**

   这是一个反直觉的结果，原因在于：

   - **置信度阈值 ≠ 预测准确率**
     - 置信度阈值只是一个交易信号筛选器
     - 它不会改变模型本身的预测能力
     - 如果模型在高置信度时的预测准确率不高，胜率反而会下降

   - **高置信度信号数量减少**
     - 置信度0.60的交易次数（CatBoost: 72.71次）比置信度0.55（约103次）减少约30%
     - 交易频率降低，但每次交易的可靠性并未相应提升

   - **错过盈利机会**
     - 一些中等置信度（0.55-0.60）的信号被过滤掉
     - 这些信号中可能包含大量盈利交易
     - 过度筛选导致胜率和收益率双降

3. **CatBoost 模型最稳定**：
   - 胜率仅下降0.97%（最小）
   - 收益率下降32.04%（相对较小）
   - 即使在置信度0.60下仍有206.72%的高收益率
   - 是所有模型中最稳定的选择

4. **实际应用建议**：
   - **不要过度追求高置信度**：置信度0.55是更好的平衡点
   - **置信度0.60适用于保守型投资者**：愿意牺牲收益以降低交易频率
   - **更重要的是选择表现稳定的模型**：如 CatBoost
   - **关注风险调整后收益**：夏普比率比胜率和收益率更重要

**置信度阈值选择指南**：

| 投资者类型 | 推荐置信度 | 预期收益 | 预期胜率 | 交易频率 | 适用场景 |
|-----------|-----------|---------|---------|---------|---------|
| 保守型 | 0.60-0.65 | 较低 | 较低 | 低 | 风险控制优先 |
| 平衡型 | 0.55 | 中等 | 中等 | 中等 | 收益与风险平衡 |
| 进取型 | 0.50-0.55 | 较高 | 较高 | 高 | 追求更高收益 |

### 各股票回测结果对比表（2026-02-22）

下表展示了28只自选股在四个模型（LightGBM、GBDT、CatBoost、融合模型）上的回测结果对比，按平均总收益率排序。**黑体表示该股票在该模型上表现优秀（收益率>50%）**：

| 股票代码 | 股票名称 | LightGBM收益率 | GBDT收益率 | CatBoost收益率 | 融合模型收益率 |
|---------|---------|--------------|-----------|--------------|--------------|
| 1347.HK | 华虹半导体 | **86.31%** | **99.25%** | **1353.20%** | **374.67%** |
| 0981.HK | 中芯国际 | 24.60% | **62.64%** | **726.73%** | **311.36%** |
| 9660.HK | 地平线机器人 | -19.96% | 3.97% | **341.58%** | **360.15%** |
| 1810.HK | 小米集团-W | -15.10% | -27.51% | **490.56%** | **164.29%** |
| 2269.HK | 药明生物 | -14.05% | -34.41% | **370.34%** | **274.41%** |
| 9988.HK | 阿里巴巴-SW | -34.50% | -22.99% | **380.87%** | **258.56%** |
| 1330.HK | 绿色动力环保 | **91.86%** | **103.26%** | **195.50%** | **179.16%** |
| 1138.HK | 中远海能 | -2.60% | **50.29%** | **243.24%** | **77.69%** |
| 1288.HK | 农业银行 | 7.93% | 17.36% | **177.30%** | **101.14%** |
| 0700.HK | 腾讯控股 | -28.80% | -18.75% | **214.76%** | **132.00%** |
| 1109.HK | 华润置地 | -14.86% | -18.73% | **188.38%** | **75.82%** |
| 0883.HK | 中国海洋石油 | 10.73% | 15.56% | **139.02%** | **53.49%** |
| 2800.HK | 盈富基金 | -1.71% | -6.80% | **127.00%** | **81.43%** |
| 1088.HK | 中国神华 | 18.40% | 27.68% | **92.64%** | 47.03% |
| 0939.HK | 建设银行 | -6.20% | 5.92% | **107.75%** | **74.95%** |
| 1211.HK | 比亚迪股份 | -31.09% | -36.46% | **169.66%** | **79.14%** |
| 1398.HK | 工商银行 | -12.88% | -5.45% | **127.56%** | **68.34%** |
| 0005.HK | 汇丰银行 | -13.55% | -7.21% | **124.08%** | **62.43%** |
| 3968.HK | 招商银行 | -20.30% | -27.01% | **128.65%** | **66.65%** |
| 0388.HK | 香港交易所 | -48.07% | -38.55% | **155.98%** | **76.04%** |
| 0016.HK | 新鸿基地产 | -42.08% | -37.88% | **164.27%** | **50.89%** |
| 3690.HK | 美团-W | -33.54% | -43.17% | **138.60%** | **70.30%** |
| 0012.HK | 恒基地产 | -1.52% | -14.51% | **100.97%** | 41.96% |
| 2533.HK | 黑芝麻智能 | 1.55% | 12.01% | 31.01% | **79.87%** |
| 6682.HK | 第四范式 | -64.65% | -49.78% | **207.30%** | 12.86% |
| 0941.HK | 中国移动 | 6.90% | 7.64% | 9.45% | 22.66% |
| 0728.HK | 中国电信 | -14.21% | -16.31% | **51.57%** | 23.79% |
| 1299.HK | 友邦保险 | -58.65% | -52.17% | **127.17%** | 2.51% |

### 模型性能对比（2026-02-22）

| 模型 | 平均总收益率 | 平均夏普比率 | 平均最大回撤 | 平均胜率 | 最高收益率 | 最低收益率 | 建议 |
|------|------------|------------|------------|---------|----------|----------|------|
| **CatBoost 20天** | **238.76%** | **1.51** | -19.08% | **32.81%** | **1353.20%** | 9.45% | ⭐⭐⭐⭐⭐ 最佳 |
| 融合模型（加权平均） | 115.13% | 1.00 | -23.07% | 31.89% | 374.67% | 2.51% | ⭐⭐⭐⭐⭐ 推荐 |
| GBDT 20天 | -1.86% | -0.06 | -37.93% | 29.88% | 103.26% | -52.17% | ⭐⭐⭐ 一般 |
| LightGBM 20天 | -8.22% | -0.18 | -37.12% | 29.57% | 91.86% | **-64.65%** | ⭐⭐ 较差 |

### 关键发现

1. **CatBoost 模型表现最佳**：
   - 平均总收益率 238.76%，远超其他模型
   - 平均夏普比率 1.51，风险调整后收益优秀
   - 优秀股票数量最多（24只，收益率>50%）
   - 在24只股票上都实现了超过50%的收益率

2. **融合模型表现稳健**：
   - 平均总收益率 115.13%，显著高于LightGBM和GBDT
   - 平均夏普比率 1.00，风险调整后收益良好
   - 优秀股票数量较多（22只，收益率>50%）
   - 降低单一模型风险，提升稳定性

3. **股票差异性明显**：
   - 不同股票的回测结果差异较大
   - 部分股票表现优秀（如 1347.HK 华虹半导体在CatBoost模型上收益率达1353.20%）
   - 部分股票表现较差（如 6682.HK 第四范式在LightGBM模型上收益率-64.65%）

4. **模型一致性**：
   - 所有模型在相同股票上的表现趋势一致
   - CatBoost和融合模型在大多数股票上表现优秀
   - 收益率>50%的股票在CatBoost和融合模型中占比高（86%和79%）

### 实际应用建议

基于批量回测结果，建议：

1. **优先使用融合模型**：
   - 整体表现最佳
   - 风险控制能力最强
   - 优秀股票数量最多

2. **关注高置信度股票**：
   - 选择融合模型预测概率 > 0.60 的股票
   - 重点关注夏普比率 > 1.0 的股票
   - 避免最大回撤 > -30% 的股票

3. **分散投资**：
   - 选择 3-5 只优秀股票构建组合
   - 避免集中在单一行业
   - 定期调整持仓

4. **风险控制**：
   - 设置止损位（-8% 至 -10%）
   - 控制单只股票仓位（3-5%）
   - 总仓位控制在 50-70%

### 注意事项

1. **回测时间**：批量回测28只股票需要较长时间（约1-2小时）
2. **数据要求**：需要完整的历史价格数据
3. **模型加载**：确保模型文件存在且正确
4. **结果解读**：批量回测结果仅供参考，实盘需要考虑更多因素
5. **推荐使用批量回测**：批量回测是唯一推荐的回测方式，可以全面评估模型在不同股票上的表现

## CatBoost vs GBDT 表现差异分析

### 核心差异

**CatBoost表现**：24只股票收益率>50%，平均收益率238.76%，标准偏差±1.50%
**GBDT表现**：4只股票收益率>50%，平均收益率-1.86%，标准偏差±4.34%

CatBoost在28只股票中的24只都实现了超过50%的收益率，而GBDT只有4只，差异极其显著。

### CatBoost表现优异的五大关键原因

#### 1. 自动分类特征处理（CatBoost的核心优势）

CatBoost能够自动识别和处理分类特征，使用先进的**Ordered Target Statistics**方法，避免了GBDT常见的**Target Leakage**问题。

**股票数据中的分类特征**：
- 股票类型特征（18种行业类型：银行、科技、半导体、AI、能源等）
- 情感分析分类（正面/负面/中性）
- 主题分布特征（10个LDA主题）
- 技术信号分类（超买/超卖/中性）

**GBDT的局限**：
- 需要手动进行One-Hot编码或Label Encoding
- Label Encoding可能引入虚假的序数关系（如银行=0，科技=1，但这不代表科技>银行）
- One-Hot编码会导致特征维度爆炸，增加计算负担

**CatBoost的优势**：
- 自动检测字符串类型的分类特征
- 使用目标统计编码（Target Statistics），保留分类特征的信息
- 避免了特征维度爆炸问题
- 更好地捕捉分类特征与目标变量之间的关系

#### 2. Ordered Boosting算法（避免过拟合）

CatBoost使用**Ordered Boosting**算法，这是它的核心创新之一。

**工作原理**：
- 对训练数据进行有序排列
- 每个样本的梯度只使用之前样本的信息计算
- 避免了训练集和验证集之间的信息泄露
- 类似于时间序列交叉验证的理念

**对比GBDT**：
- GBDT使用标准梯度提升，存在训练集-验证集信息泄露
- 导致在训练集上表现过好，但在测试集上泛化能力差
- 这解释了为什么GBDT在回测中表现不稳定（标准偏差±4.34%）

**CatBoost的效果**：
- 标准偏差仅±1.50%，比GBDT降低65.8%
- 在不同股票上的表现更加稳定一致
- 更好的泛化能力，避免过拟合

#### 3. 更好的正则化和参数配置

CatBoost在20天模型上使用了更优的正则化配置：

**CatBoost 20天参数**：
```python
depth = 7                    # 树深度适中
learning_rate = 0.05        # 较小的学习率
l2_leaf_reg = 3             # L2正则化
subsample = 0.75            # 行采样（75%的样本）
colsample_bylevel = 0.7     # 列采样（70%的特征）
early_stopping_rounds = 40  # 早停机制
n_estimators = 500          # 树数量
```

**这些参数的优势**：
- 较小的学习率+更多的树数量=更稳定的模型
- L2正则化防止过拟合，控制模型复杂度
- 采样机制增加模型多样性，避免过拟合
- 早停机制避免过度训练，提前停止

**对比GBDT**：
- GBDT的正则化配置相对简单
- 容易过拟合，特别是在样本量较大的情况下
- 在股票数据中，GBDT容易学习到短期噪声

#### 4. 更强大的特征工程能力

CatBoost在处理复杂特征交互方面表现更出色。

**重要特征类型**（基于特征重要性分析）：

1. **市场环境特征（最重要）**：
   - HSI_Return_5d（恒生指数5日收益率）- 重要性408
   - HSI_Return（恒生指数收益率）- 重要性336
   - 美股市场特征（标普500、VIX、国债收益率）

2. **技术指标特征**：
   - Vol_Ratio（成交量比率）- 重要性185
   - BB_width（布林带宽度）- 重要性139
   - ATR（真实波幅）- 重要性133
   - Price_Ratio_MA50（价格相对MA50比率）- 重要性130

3. **动量特征**：
   - MACD_histogram（MACD柱状图）- 重要性117
   - RSI（相对强弱指标）- 重要性113
   - Return_20d（20日收益率）- 重要性109

**CatBoost的发现**：
- CatBoost能够更好地捕捉这些特征之间的复杂交互关系
- 特别是市场环境特征与技术指标的交互
- 能够识别不同股票类型对不同特征的敏感性差异
- 例如：科技股对VIX更敏感，银行股对利率更敏感

**GBDT的局限**：
- GBDT在处理高维特征交互时容易过拟合
- 难以捕捉复杂的非线性关系
- 对噪声数据更敏感

#### 5. 更好的泛化能力和稳定性

**CatBoost的稳定性优势**：
- 标准偏差：±1.50%
- 准确率：61.09%
- 在24只股票上都实现了>50%的收益率

**GBDT的稳定性问题**：
- 标准偏差：±4.34%
- 准确率：58.84%
- 只有4只股票实现>50%的收益率

**差异原因**：
- CatBoost的Ordered Boosting减少了训练集-验证集信息泄露
- 更好的正则化机制（L2、采样、早停）
- 对噪声数据的鲁棒性更强
- 自动分类特征处理避免了编码误差

### CatBoost找到的重要特征

根据特征重要性分析，CatBoost最关注的特征类型：

#### 1. 市场环境特征（最重要）

- **恒生指数5日收益率**（重要性408）：表明CatBoost非常重视大盘环境对个股的影响
- **恒生指数收益率**（重要性336）：大盘的整体趋势
- **美股市场特征**：标普500、VIX、美国国债收益率等全球市场因素

**投资启示**：
- CatBoost能够准确捕捉恒生指数和美股市场对个股的影响
- 这解释了为什么CatBoost在不同股票上都表现优秀
- 它能够根据市场环境动态调整预测策略

#### 2. 技术指标特征

- **成交量比率**（重要性185）：资金流向信号
- **布林带宽度**（重要性139）：波动率信号
- **ATR**（重要性133）：波动幅度
- **价格相对MA50比率**（重要性130）：趋势信号

**投资启示**：
- CatBoost特别擅长识别量价关系
- 对波动率变化的敏感度高
- 能够捕捉趋势反转信号

#### 3. 动量特征

- **MACD柱状图**（重要性117）：动量变化
- **RSI**（重要性113）：超买超卖信号
- **20日收益率**（重要性109）：短期动量

**投资启示**：
- CatBoost重视动量指标的组合使用
- 能够识别动量反转和持续信号
- 对短期价格变化的捕捉能力强

### 实际应用建议

#### 为什么CatBoost在24只股票上表现优秀？

1. **市场环境敏感度高**：
   - CatBoost能够准确捕捉恒生指数和美股市场对个股的影响
   - 根据市场环境动态调整预测策略
   - 避免在市场下跌时盲目买入

2. **技术指标识别能力强**：
   - 特别擅长识别量价关系和趋势信号
   - 能够捕捉技术指标的复杂交互关系
   - 对不同技术指标的权重分配更合理

3. **分类特征处理优秀**：
   - 对股票类型、行业特征、情感特征的利用更充分
   - 能够识别不同行业的特征差异
   - 例如：科技股和银行股对同一特征的响应不同

4. **泛化能力强**：
   - 在不同股票上的表现更加稳定一致
   - 避免了过拟合问题
   - 对新数据的适应能力强

#### 推荐使用CatBoost的场景

- ✅ 需要处理大量分类特征（行业、主题、情感等）
- ✅ 追求模型稳定性和泛化能力
- ✅ 市场环境变化较大的时期
- ✅ 需要在多只股票上保持一致表现
- ✅ 对风险控制要求较高的场景

#### CatBoost vs GBDT 选择建议

| 场景 | 推荐模型 | 原因 |
|------|---------|------|
| 多股票组合投资 | CatBoost | 在多只股票上表现一致，稳定性好 |
| 分类特征较多 | CatBoost | 自动处理分类特征，避免编码误差 |
| 追求稳定性 | CatBoost | 标准偏差小，泛化能力强 |
| 快速原型开发 | GBDT | 实现简单，调参相对容易 |
| 特征工程较少 | GBDT | 对特征工程要求相对较低 |
| 生产环境部署 | CatBoost | 稳定性好，泛化能力强 |

### CatBoost的优势总结

1. **✅ 自动分类特征处理**：避免编码误差，保留分类特征信息
2. **✅ Ordered Boosting**：避免训练集-验证集信息泄露，减少过拟合
3. **✅ 更好的正则化配置**：L2、采样、早停机制，提升稳定性
4. **✅ 更强的特征交互学习能力**：捕捉复杂特征交互关系
5. **✅ 更好的泛化能力和稳定性**：标准偏差±1.50%，远超GBDT
6. **✅ 在多只股票上表现一致**：24/28只股票收益率>50%

### CatBoost的潜在局限

虽然CatBoost表现优异，但也需要注意：

1. **训练时间较长**：相比GBDT，CatBoost的训练时间可能更长
2. **内存占用较高**：Ordered Boosting需要额外的内存开销
3. **参数调优**：虽然默认参数很好，但进一步调优可能需要更多时间
4. **短期预测风险**：CatBoost 1天模型存在过拟合风险，不推荐使用

### 最佳实践建议

**优先使用CatBoost 20天模型**：
- 准确率61.09%（±1.50%）
- 平均收益率238.76%
- 24只股票收益率>50%
- 稳定性最佳

**谨慎使用CatBoost 1天模型**：
- 准确率65.62%（±5.97%）
- 标准偏差过高
- 存在严重过拟合风险
- 不推荐使用

**融合模型作为备选**：
- CatBoost + LightGBM + GBDT
- 加权平均融合
- 进一步降低风险，提升稳定性

## 常见问题

**Q: 为什么回测结果比准确率评估差？**
A: 准确率只评估方向正确性，回测考虑了交易成本、资金利用率等因素，更接近真实交易。

**Q: 如何调整置信度阈值？**
A: 可以在调用`backtest_model`时设置`confidence_threshold`参数，或修改代码中的默认值。三分类预测的置信度阈值为 0.60（高置信度上涨）和 0.50（中等置信度观望）。

**Q: 回测结果可以用于实盘吗？**
A: 可以作为参考，但实盘还需要考虑市场环境、流动性、滑点等因素。建议先进行小资金测试。CatBoost 20天模型和融合模型具有较高的可信度，优先推荐使用。

**Q: 为什么模型策略跑输基准？**
A: 可能原因：1) 模型准确率不够高；2) 交易成本过高；3) 市场环境不适合模型策略；4) 参数设置不当。

**Q: 什么是三分类预测？**
A: 三分类预测将预测结果分为上涨、观望、下跌三类，基于融合概率进行划分：
- fused_probability > 0.60：上涨（高置信度）
- 0.50 < fused_probability ≤ 0.60：观望（中等置信度）
- fused_probability ≤ 0.50：下跌（低置信度）

**Q: 为什么 CatBoost 1天模型不推荐使用？**
A: CatBoost 1天模型准确率65.62%（±5.97%），标准偏差过高，存在严重过拟合风险。短期波动噪声被模型过度学习，建议使用 CatBoost 20天模型和融合模型。

**Q: 融合模型如何计算权重？**
A: 加权平均融合方法基于模型准确率自动分配权重：weight = accuracy / std。CatBoost 由于高准确率和低标准偏差，通常获得较高的权重。

**Q: 如何理解置信度和一致性？**
A: 置信度反映预测的可信程度（基于融合概率），一致性反映多模型的意见统一程度（基于模型预测一致性）。两者独立评估，高置信度 + 高一致性 = 强烈信号。

## 更新日志

- **2026-02-22**: 删除单只股票回测功能，只保留批量回测功能
  - 删除 `--mode backtest` 参数选项
  - 删除随机股票选择功能
  - 更新使用方法，推荐使用批量回测功能
  - 添加置信度0.60的批量回测结果数据
  - 添加 CatBoost 批量回测详细表现（23只优秀股票）

- **2026-02-21**: 更新模型性能数据至最新（来自 `data/model_accuracy.json`）
  - CatBoost 20天：61.09%（±1.50%）⭐ 当前最佳（稳定可靠）
  - CatBoost 5天：63.01%（±4.45%）⚠️ 谨慎使用
  - CatBoost 1天：65.62%（±5.97%）❌ 不推荐使用（过拟合风险高）
  - LightGBM 20天：58.87%（±4.38%）
  - GBDT 20天：58.84%（±4.34%）
  - 添加三分类预测标准（上涨/观望/下跌）
  - 更新实际应用建议，反映置信度和一致性综合判断
  - 添加 CatBoost 模型优势说明

- **2026-02-20**: CatBoost 算法集成和模型融合功能
  - 集成 CatBoost 模型，支持自动处理分类特征
  - 实现三模型融合（LightGBM + GBDT + CatBoost）
  - 支持三种融合方法（简单平均、加权平均、投票机制）
  - 置信度评估（高/中/低）
  - 一致性评估（100%/67%/50%/33%）

- **2026-02-18**: 初始版本，实现基础回测功能
  - 支持夏普比率、索提诺比率、最大回撤等关键指标
  - 支持可视化报告生成（4个子图）
  - 集成到主脚本中
  - 随机股票选择功能
  - 股票信息记录（代码、策略、选择方法）